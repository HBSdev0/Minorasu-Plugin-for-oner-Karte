<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BI Dashboard Plugin Settings</title>
    <style>
      /* MRADERCHARTスタイルの色選択UI */
      .color-selection { margin-top: 10px; }
      .color-options { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
      .color-option { 
        width: 30px; 
        height: 30px; 
        border: 2px solid #ddd; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: all 0.2s; 
      }
      .color-option:hover { 
        border-color: #3498db; 
        transform: scale(1.1); 
      }
      .color-option.selected { 
        border-color: #2c3e50; 
        border-width: 3px; 
      }
      .color-picker-container { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        margin-top: 8px;
      }
      .color-picker { 
        width: 40px; 
        height: 30px; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
        cursor: pointer; 
      }
      .color-picker-label { 
        font-size: 0.9rem; 
        color: #666; 
      }
      .role-color-group { 
        display: flex; 
        flex-direction: column; 
        gap: 20px; 
      }
      .role-color-item { 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
      }
      .role-color-item label { 
        font-weight: 600; 
        color: #2c3e50; 
        font-size: 1rem; 
      }
      
      /* レスポンシブ対応 */
      @media (max-width: 768px) { 
        .role-color-group { gap: 15px; }
        .color-options { gap: 4px; }
        .color-option { width: 28px; height: 28px; }
      }
    </style>
</head>
<body>
    <div class="plugin-container">
        <main class="plugin-main">
            <div class="settings-section">
                <h2>全般設定</h2>
                <div class="space-config">
                    <div class="space-group">
                        <label for="spaceId">表示スペースID</label>
                        <input type="text" id="spaceId" class="space-input" placeholder="例: dashboard">
                        <p class="help-text">プラグインのダッシュボードを表示するスペースフィールドのIDを指定してください。</p>
                    </div>
                </div>
                
                <div class="current-app-config">
                    <div class="current-app-group">
                        <label for="currentAppOwnerId">自アプリ内のオーナーIDフィールド</label>
                        <select id="currentAppOwnerId" class="app-dropdown kintone-current-app-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                        <p class="help-text">このアプリ内でオーナーを識別するためのフィールドを選択してください。</p>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>データソース設定</h2>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="owner">①オーナーマスタ</button>
                        <button class="tab-button" data-tab="property">②物件マスタ</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="ownerTab" class="tab-pane active">
                            <div class="mapping-group">
                                <h3>オーナーマスタ の設定</h3>
                                
                                <div class="app-selection">
                                    <div class="app-group">
                                        <label for="ownerAppId">アプリを選択</label>
                                        <select id="ownerAppId" class="app-dropdown kintone-app-select"></select>
                                    </div>
                                </div>
                                
                                <h4>オーナーID設定</h4>
                                <div class="field-mappings" id="ownerIdMappings">
                                    <!-- Owner ID field will be dynamically added here by JS -->
                                </div>
                                
                                <h4>フィールドマッピング</h4>
                                <div class="field-mappings" id="ownerFieldMappings">
                                    <!-- Fields will be dynamically added here by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="propertyTab" class="tab-pane">
                            <div class="mapping-group">
                                <h3>物件マスタの設定</h3>
                                
                                <div class="app-selection">
                                    <div class="app-group">
                                        <label for="propertyAppId">アプリを選択</label>
                                        <select id="propertyAppId" class="app-dropdown kintone-app-select"></select>
                                    </div>
                                </div>
                                
                                <h4>オーナーID設定</h4>
                                <div class="field-mappings" id="propertyOwnerIdMappings">
                                    <!-- Property Owner ID field will be dynamically added here by JS -->
                                </div>
                                
                                <h4>物件名設定</h4>
                                <div class="field-mappings" id="propertyNameMappings">
                                    <!-- Property Name field will be dynamically added here by JS -->
                                </div>
                                
                                <h4>フィールドマッピング</h4>
                                <div class="field-mappings" id="propertyFieldMappings">
                                    <!-- Fields will be dynamically added here by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>成績基準設定</h2>
                <p class="help-text">各指標の成績評価基準を設定できます。成績は1（低い）から5（高い）の5段階で評価されます。</p>
                <p class="help-text">上から順に優先されます。左端の↑↓ボタンで並べ替えできます。</p>
                
                <div class="grade-settings">
                    <div class="metric-group">
                        <h3>資産効率 (%)</h3>
                        <p class="metric-description">高いほど良い指標：実勢価格 ÷ 相続税評価額 × 100</p>
                        
                        <div class="grade-table" id="assetEfficiency_grade_table">
                            <div class="grade-ranges" id="assetEfficiency_grade_ranges"></div>
                            <button type="button" class="add-range-btn" data-metric="assetEfficiency">範囲を追加</button>
                        </div>
                    </div>

                    <div class="metric-group">
                        <h3>ROA (%)</h3>
                        <p class="metric-description">高いほど良い指標：収支 ÷ 相続税評価額 × 100</p>
                        
                        <div class="grade-table" id="roa_grade_table">
                            <div class="grade-ranges" id="roa_grade_ranges"></div>
                            <button type="button" class="add-range-btn" data-metric="roa">範囲を追加</button>
                        </div>
                    </div>

                    <div class="metric-group">
                        <h3>所得税率 (%)</h3>
                        <p class="metric-description">低いほど良い指標：税率が低いほど高評価</p>
                        
                        <div class="grade-table" id="incomeTax_grade_table">
                            <div class="grade-ranges" id="incomeTax_grade_ranges"></div>
                            <button type="button" class="add-range-btn" data-metric="incomeTax">範囲を追加</button>
                        </div>
                    </div>

                    <div class="metric-group">
                        <h3>運営コスト率 (%)</h3>
                        <p class="metric-description">低いほど良い指標：運営コスト ÷ 満室賃料 × 100</p>
                        
                        <div class="grade-table" id="operatingCost_grade_table">
                            <div class="grade-ranges" id="operatingCost_grade_ranges"></div>
                            <button type="button" class="add-range-btn" data-metric="operatingCost">範囲を追加</button>
                        </div>
                    </div>

                    <div class="metric-group">
                        <h3>NOI率 (%)</h3>
                        <p class="metric-description">高いほど良い指標：NOI ÷ 満室賃料 × 100</p>
                        
                        <div class="grade-table" id="noi_grade_table">
                            <div class="grade-ranges" id="noi_grade_ranges"></div>
                            <button type="button" class="add-range-btn" data-metric="noi">範囲を追加</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>平均値の取得方法</h2>
                <div class="average-mode-group">
                    <label><input type="radio" name="averageMode" value="compute" checked> 全レコードから平均を算出（現行）</label>
                    <br>
                    <label><input type="radio" name="averageMode" value="savedField"> 自アプリの平均値フィールドを使用</label>
                </div>
                <div id="averageFieldMappings" class="average-field-mappings" style="margin-top: 8px; display: none;">
                    <div class="field-mapping">
                        <label for="avgAssetEfficiencyField">資産効率平均</label>
                        <select id="avgAssetEfficiencyField" class="kintone-current-app-field-select average-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                    </div>
                    <div class="field-mapping">
                        <label for="avgRoaField">ROA平均</label>
                        <select id="avgRoaField" class="kintone-current-app-field-select average-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                    </div>
                    <div class="field-mapping">
                        <label for="avgIncomeTaxField">所得税率平均</label>
                        <select id="avgIncomeTaxField" class="kintone-current-app-field-select average-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                    </div>
                    <div class="field-mapping">
                        <label for="avgOperatingCostField">運営コスト率平均</label>
                        <select id="avgOperatingCostField" class="kintone-current-app-field-select average-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                    </div>
                    <div class="field-mapping">
                        <label for="avgNoiField">NOI率平均</label>
                        <select id="avgNoiField" class="kintone-current-app-field-select average-field-select">
                            <option value="">フィールドを選択してください</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>グラフ配色</h2>
                <p class="help-text">各系列（現状・平均・試算）ごとに、カラーパレットから色を選ぶかカスタムで指定します。</p>
                <div class="role-color-group">
                    <div class="role-color-item">
                        <label>現状 色</label>
                        <div class="color-selection">
                            <div class="color-options" id="paletteCurrent">
                                <div class="color-option selected" data-role="current" data-color="#007BFF" style="background-color:#007BFF"></div>
                                <div class="color-option" data-role="current" data-color="#1E88E5" style="background-color:#1E88E5"></div>
                                <div class="color-option" data-role="current" data-color="#4CAF50" style="background-color:#4CAF50"></div>
                                <div class="color-option" data-role="current" data-color="#009E73" style="background-color:#009E73"></div>
                                <div class="color-option" data-role="current" data-color="#E69F00" style="background-color:#E69F00"></div>
                                <div class="color-option" data-role="current" data-color="#FF5722" style="background-color:#FF5722"></div>
                                <div class="color-option" data-role="current" data-color="#E53935" style="background-color:#E53935"></div>
                                <div class="color-option" data-role="current" data-color="#AB47BC" style="background-color:#AB47BC"></div>
                                <div class="color-option" data-role="current" data-color="#7E57C2" style="background-color:#7E57C2"></div>
                                <div class="color-option" data-role="current" data-color="#607D8B" style="background-color:#607D8B"></div>
                                <div class="color-option" data-role="current" data-color="#FDD835" style="background-color:#FDD835"></div>
                                <div class="color-option" data-role="current" data-color="#00897B" style="background-color:#00897B"></div>
                            </div>
                            <div class="color-picker-container">
                                <input type="color" class="color-picker" id="colorCurrent" data-role="current" value="#007bff">
                                <span class="color-picker-label">カスタム</span>
                            </div>
                        </div>
                    </div>

                    <div class="role-color-item">
                        <label>平均 色</label>
                        <div class="color-selection">
                            <div class="color-options" id="paletteAverage">
                                <div class="color-option" data-role="average" data-color="#007BFF" style="background-color:#007BFF"></div>
                                <div class="color-option" data-role="average" data-color="#1E88E5" style="background-color:#1E88E5"></div>
                                <div class="color-option" data-role="average" data-color="#4CAF50" style="background-color:#4CAF50"></div>
                                <div class="color-option" data-role="average" data-color="#009E73" style="background-color:#009E73"></div>
                                <div class="color-option" data-role="average" data-color="#E69F00" style="background-color:#E69F00"></div>
                                <div class="color-option selected" data-role="average" data-color="#FF5722" style="background-color:#FF5722"></div>
                                <div class="color-option" data-role="average" data-color="#E53935" style="background-color:#E53935"></div>
                                <div class="color-option" data-role="average" data-color="#AB47BC" style="background-color:#AB47BC"></div>
                                <div class="color-option" data-role="average" data-color="#7E57C2" style="background-color:#7E57C2"></div>
                                <div class="color-option" data-role="average" data-color="#607D8B" style="background-color:#607D8B"></div>
                                <div class="color-option" data-role="average" data-color="#FDD835" style="background-color:#FDD835"></div>
                                <div class="color-option" data-role="average" data-color="#00897B" style="background-color:#00897B"></div>
                            </div>
                            <div class="color-picker-container">
                                <input type="color" class="color-picker" id="colorAverage" data-role="average" value="#ff5722">
                                <span class="color-picker-label">カスタム</span>
                            </div>
                        </div>
                    </div>

                    <div class="role-color-item">
                        <label>試算 色</label>
                        <div class="color-selection">
                            <div class="color-options" id="paletteForecast">
                                <div class="color-option" data-role="forecast" data-color="#007BFF" style="background-color:#007BFF"></div>
                                <div class="color-option" data-role="forecast" data-color="#1E88E5" style="background-color:#1E88E5"></div>
                                <div class="color-option selected" data-role="forecast" data-color="#4CAF50" style="background-color:#4CAF50"></div>
                                <div class="color-option" data-role="forecast" data-color="#009E73" style="background-color:#009E73"></div>
                                <div class="color-option" data-role="forecast" data-color="#E69F00" style="background-color:#E69F00"></div>
                                <div class="color-option" data-role="forecast" data-color="#FF5722" style="background-color:#FF5722"></div>
                                <div class="color-option" data-role="forecast" data-color="#E53935" style="background-color:#E53935"></div>
                                <div class="color-option" data-role="forecast" data-color="#AB47BC" style="background-color:#AB47BC"></div>
                                <div class="color-option" data-role="forecast" data-color="#7E57C2" style="background-color:#7E57C2"></div>
                                <div class="color-option" data-role="forecast" data-color="#607D8B" style="background-color:#607D8B"></div>
                                <div class="color-option" data-role="forecast" data-color="#FDD835" style="background-color:#FDD835"></div>
                                <div class="color-option" data-role="forecast" data-color="#00897B" style="background-color:#00897B"></div>
                            </div>
                            <div class="color-picker-container">
                                <input type="color" class="color-picker" id="colorForecast" data-role="forecast" value="#4caf50">
                                <span class="color-picker-label">カスタム</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" id="plugin_cancel" class="btn btn-secondary">キャンセル</button>
                <button type="button" id="plugin_submit" class="btn btn-primary">設定を保存</button>
            </div>
        </main>
    </div>
</body>
</html>
