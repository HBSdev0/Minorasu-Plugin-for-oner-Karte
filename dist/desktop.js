/**
 * ============================================================================
 * オーナーカルテ用試算ダッシュボード表示プラグイン
 * ============================================================================
 * 
 * Copyright (c) 2025 ほっとビジネスサポート株式会社
 * All rights reserved.
 * 
 * Website: https://hot-bs.co.jp/
 * 
 * This software is proprietary and confidential.
 * 
 * LICENSE TERMS AND CONDITIONS:
 * 
 * 1. GRANT OF LICENSE
 *    Subject to the terms and conditions of this Agreement, you are granted
 *    a limited, non-exclusive, non-transferable license to use this software
 *    solely for your internal business purposes.
 * 
 * 2. RESTRICTIONS
 *    You may not:
 *    - Reverse engineer, decompile, or disassemble the software
 *    - Modify, adapt, or create derivative works based on the software
 *    - Remove or alter any proprietary notices or labels on the software
 *    - Resell, redistribute, or transfer the software to any third party
 *    - Use the software for any illegal or unauthorized purpose
 *    - Attempt to gain unauthorized access to the software or its systems
 * 
 * 3. OWNERSHIP
 *    This software and all intellectual property rights therein shall
 *    remain the exclusive property of ほっとビジネスサポート株式会社.
 *    You acknowledge that no title to the intellectual property in the
 *    software is transferred to you.
 * 
 * 4. WARRANTY DISCLAIMER
 *    THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
 *    EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 *    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 *    PURPOSE. IN NO EVENT SHALL ほっとビジネスサポート株式会社 BE LIABLE
 *    FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 *    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
 *    OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 *    OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 *    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 *    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
 *    THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 *    SUCH DAMAGE.
 * 
 * 5. TERMINATION
 *    This license is effective until terminated. Your rights under this
 *    license will terminate automatically without notice if you fail to
 *    comply with any of its terms and conditions.
 * 
 * 6. GOVERNING LAW
 *    This Agreement shall be governed by and construed in accordance
 *    with the laws of Japan.
 * 
 * ============================================================================
 * 
 * Third-Party Libraries Used:
 * 
 * Chart.js (v4.4.3) - MIT License
 * Copyright (c) 2013-2023 Chart.js Contributors
 * https://github.com/chartjs/Chart.js
 * 
 * jQuery (v3.7.1) - MIT License
 * Copyright (c) 2010-2023 jQuery Foundation, Inc.
 * https://jquery.com/
 * 
 * ============================================================================
 * 
 * Build Date: 2025-09-09
 * Author: ほっとビジネスサポート株式会社
 * License: Proprietary Commercial License
 * ============================================================================
 */ 
!function(){"use strict";function e(e){const{roa:t,propertyDetails:n}=e,a=document.createElement("div");a.className="tab-content active",a.dataset.tab="roa";const o=n.map((e,t)=>{var n,a,o,r,i,l,c,d,s,u;const p=parseFloat((null==(n=e.market_price)?void 0:n.value)||0),m=parseFloat((null==(a=e.income)?void 0:a.value)||0),v=parseFloat((null==(o=e.inheritance_tax_value)?void 0:o.value)||0),g=v>0?p/v*100:0,y=v>0?m/v*100:0;return`\n        <tr data-prop-index="${t}" data-scenario="current" class="readonly-row">\n            <td rowspan="2">${(null==(r=e.property_name)?void 0:r.value)??""}</td>\n            <td>現状</td>\n            <td><input type="text" id="roaProp_${t}_current_market" value="${(null==(i=e.market_price)?void 0:i.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_income" value="${(null==(l=e.income)?void 0:l.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_inheritance" value="${(null==(c=e.inheritance_tax_value)?void 0:c.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_assetEfficiency" value="${g.toFixed(1)}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_roa" value="${y.toFixed(1)}" readonly></td>\n        </tr>\n        <tr data-prop-index="${t}" data-scenario="forecast">\n            <td>試算</td>\n            <td><input type="text" id="roaProp_${t}_forecast_market" value="${(null==(d=e.market_price)?void 0:d.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_income" value="${(null==(s=e.income)?void 0:s.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_inheritance" value="${(null==(u=e.inheritance_tax_value)?void 0:u.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_assetEfficiency" value="${g.toFixed(1)}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_forecast_roa" value="${y.toFixed(1)}" readonly></td>\n        </tr>\n    `}).join("");function r(e){return(null==e?"":String(e)).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function i(e){const t=(e||"").toString().replace(/,/g,""),n=parseFloat(t);return isNaN(n)?0:n}function l(e){const t=(e.value||"").replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,o=r(t);if(a!==o){e.value=o;const t=(a.match(/,/g)||[]).length,r=n+((o.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(r,o.length)),Math.max(0,Math.min(r,o.length)))}}}function c(){const e=n.length;let t=0,a=0,o=0,l=0,c=0,d=0;for(let n=0;n<e;n++){t+=i(document.getElementById(`roaProp_${n}_current_market`).value),a+=i(document.getElementById(`roaProp_${n}_current_income`).value),o+=i(document.getElementById(`roaProp_${n}_current_inheritance`).value);l+=i(document.getElementById(`roaProp_${n}_forecast_market`).value),c+=i(document.getElementById(`roaProp_${n}_forecast_income`).value),d+=i(document.getElementById(`roaProp_${n}_forecast_inheritance`).value)}document.getElementById("roaTblCurrentMarketPrice").value=r(t),document.getElementById("roaTblCurrentIncome").value=r(a),document.getElementById("roaTblCurrentInheritance").value=r(o),document.getElementById("roaTblForecastMarketPrice").value=r(l),document.getElementById("roaTblForecastIncome").value=r(c),document.getElementById("roaTblForecastInheritance").value=r(d);const s=o>0?t/o*100:0,u=d>0?l/d*100:0,p=o>0?a/o*100:0,m=d>0?c/d*100:0;document.getElementById("roaTblCurrentAssetEfficiency").value=s.toFixed(1),document.getElementById("roaTblCurrentRoa").value=p.toFixed(1),document.getElementById("roaTblForecastAssetEfficiency").value=u.toFixed(1),document.getElementById("roaTblForecastRoa").value=m.toFixed(1);const v=document.getElementById("roaCurrent"),g=document.getElementById("roaForecast");v&&(v.value=p.toFixed(1),v.dispatchEvent(new Event("input",{bubbles:!0}))),g&&(g.value=m.toFixed(1),g.dispatchEvent(new Event("input",{bubbles:!0})));const y=document.getElementById("assetEfficiencyCurrent"),x=document.getElementById("assetEfficiencyForecast");y&&(y.value=s.toFixed(1),y.dispatchEvent(new Event("input",{bubbles:!0}))),x&&(x.value=u.toFixed(1),x.dispatchEvent(new Event("input",{bubbles:!0})))}function d(){c()}function s(){c()}function u(e,t){const n=document.getElementById(`roaProp_${e}_${t}_market`),a=document.getElementById(`roaProp_${e}_${t}_income`),o=document.getElementById(`roaProp_${e}_${t}_inheritance`),r=document.getElementById(`roaProp_${e}_${t}_assetEfficiency`),l=document.getElementById(`roaProp_${e}_${t}_roa`);if(!(n&&a&&o&&r&&l))return;const d=i(n.value),s=i(a.value),u=i(o.value),p=u>0?d/u*100:0,m=u>0?s/u*100:0;r.value=p.toFixed(1),l.value=m.toFixed(1),c()}a.innerHTML=`\n        <div class="form-container">\n            <table class="roa-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>実勢価格</th>\n                        <th>収支</th>\n                        <th>相続税評価額</th>\n                        <th>資産効率(%)</th>\n                        <th>ROA(%)</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="roaTblCurrentMarketPrice" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentIncome" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentInheritance" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentAssetEfficiency" value="0.0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentRoa" value="0.0" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="roaTblForecastMarketPrice" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastIncome" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastInheritance" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastAssetEfficiency" value="0.0" readonly></td>\n                        <td><input type="text" id="roaTblForecastRoa" value="0.0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n\n            <table class="roa-pivot-table">\n                <thead>\n                    <tr>\n                        <th>物件名</th>\n                        <th>現状/試算</th>\n                        <th>実勢価格</th>\n                        <th>収支</th>\n                        <th>相続税評価額</th>\n                        <th>資産効率(%)</th>\n                        <th>ROA(%)</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${o}\n                </tbody>\n            </table>\n\n            <div class="calculation-formula-container">\n                <div class="formula-content">\n                    <p>資産効率 = 実勢価格 ÷ 相続税評価額 × 100</p>\n                    <p>ROA = 収支 ÷ 相続税評価額 × 100</p>\n                </div>\n            </div>\n\n            \x3c!-- トップ表/チャート連携用（非表示） --\x3e\n            \x3c!-- ROA（%） --\x3e\n            <input type="number" id="roaCurrent" value="${t.current}" min="0" max="999" step="0.1" style="display:none;">\n            <input type="number" id="roaForecast" value="${t.forecast}" min="0" max="999" step="0.1" style="display:none;">\n            \x3c!-- 資産効率（%） --\x3e\n            <input type="number" id="assetEfficiencyCurrent" value="0" min="0" max="999" step="0.1" style="display:none;">\n            <input type="number" id="assetEfficiencyForecast" value="0" min="0" max="999" step="0.1" style="display:none;">\n        </div>\n    `;const p=document.getElementById("roaTblCurrentRoa");p&&(p.value=Number(t.current||0).toFixed(1));const m=document.getElementById("roaTblForecastRoa");return m&&(m.value=Number(t.forecast||0).toFixed(1)),["roaTblForecastMarketPrice","roaTblForecastIncome","roaTblForecastInheritance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{l(e.target),d()}),t.addEventListener("blur",e=>{l(e.target)}))}),["roaTblCurrentMarketPrice","roaTblCurrentIncome","roaTblCurrentInheritance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{l(e.target),s()}),t.addEventListener("blur",e=>{l(e.target)}))}),setTimeout(()=>{["roaTblCurrentMarketPrice","roaTblCurrentIncome","roaTblCurrentInheritance","roaTblForecastMarketPrice","roaTblForecastIncome","roaTblForecastInheritance"].forEach(e=>{const t=document.getElementById(e);t&&l(t)}),s(),d();const e=n.length;for(let t=0;t<e;t++)["current","forecast"].forEach(e=>{["market","income","inheritance"].forEach(n=>{const a=document.getElementById(`roaProp_${t}_${e}_${n}`);a&&l(a)}),u(t,e)});!function(){const e=n.length;for(let t=0;t<e;t++)["market","income","inheritance"].forEach(e=>{const n=document.getElementById(`roaProp_${t}_forecast_${e}`);n&&(n.addEventListener("input",e=>{l(e.target),u(t,"forecast")}),n.addEventListener("blur",e=>{l(e.target)}))})}()},0),a}function t(e){const{operatingCost:t,propertyDetails:n}=e,a=document.createElement("div");a.className="tab-content",a.dataset.tab="operatingCost";const o=n.map((e,t)=>{var n,a,o,r,i,l,c,d,s,u,p,m,v,g,y;return`\n        <tr data-prop-index="${t}" data-scenario="current" class="readonly-row">\n            <td rowspan="2">${(null==(n=e.property_name)?void 0:n.value)??""}</td>\n            <td>現状</td>\n            <td><input type="text" id="operatingCostProp_${t}_current_rate" value="0.0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_noiRate" value="0.0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_propertyTax" value="${(null==(a=e.property_tax)?void 0:a.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_management" value="${(null==(o=e.management_fee)?void 0:o.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_repair" value="${(null==(r=e.building_repair_cost)?void 0:r.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_restoration" value="${(null==(i=e.restoration_cost)?void 0:i.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_maintenance" value="${(null==(l=e.maintenance_cost)?void 0:l.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_netIncome" value="${(null==(c=e.net_income)?void 0:c.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_fullRent" value="${(null==(d=e.full_rent)?void 0:d.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_totalCost" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_noi" value="0" readonly></td>\n        </tr>\n        <tr data-prop-index="${t}" data-scenario="forecast">\n            <td>試算</td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_rate" value="0.0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_noiRate" value="0.0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_propertyTax" value="${(null==(s=e.property_tax)?void 0:s.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_management" value="${(null==(u=e.management_fee)?void 0:u.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_repair" value="${(null==(p=e.building_repair_cost)?void 0:p.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_restoration" value="${(null==(m=e.restoration_cost)?void 0:m.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_maintenance" value="${(null==(v=e.maintenance_cost)?void 0:v.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_netIncome" value="${(null==(g=e.net_income)?void 0:g.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_fullRent" value="${(null==(y=e.full_rent)?void 0:y.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_totalCost" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_noi" value="0" readonly></td>\n        </tr>\n    `}).join("");function r(e){return(null==e?"":String(e)).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function i(e){const t=(e||"").toString().replace(/,/g,""),n=parseFloat(t);return isNaN(n)?0:n}function l(e){const t=(e.value||"").replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,o=r(t);if(a!==o){e.value=o;const t=(a.match(/,/g)||[]).length,r=n+((o.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(r,o.length)),Math.max(0,Math.min(r,o.length)))}}}function c(){const e=n.length;let t=0,a=0,o=0,l=0,c=0,d=0,s=0,u=0,p=0,m=0,v=0,g=0,y=0,x=0;for(let n=0;n<e;n++)t+=i(document.getElementById(`operatingCostProp_${n}_current_propertyTax`).value),a+=i(document.getElementById(`operatingCostProp_${n}_current_management`).value),o+=i(document.getElementById(`operatingCostProp_${n}_current_repair`).value),l+=i(document.getElementById(`operatingCostProp_${n}_current_restoration`).value),c+=i(document.getElementById(`operatingCostProp_${n}_current_maintenance`).value),d+=i(document.getElementById(`operatingCostProp_${n}_current_netIncome`).value),s+=i(document.getElementById(`operatingCostProp_${n}_current_fullRent`).value),u+=i(document.getElementById(`operatingCostProp_${n}_forecast_propertyTax`).value),p+=i(document.getElementById(`operatingCostProp_${n}_forecast_management`).value),m+=i(document.getElementById(`operatingCostProp_${n}_forecast_repair`).value),v+=i(document.getElementById(`operatingCostProp_${n}_forecast_restoration`).value),g+=i(document.getElementById(`operatingCostProp_${n}_forecast_maintenance`).value),y+=i(document.getElementById(`operatingCostProp_${n}_forecast_netIncome`).value),x+=i(document.getElementById(`operatingCostProp_${n}_forecast_fullRent`).value);document.getElementById("operatingCostTblCurrentPropertyTax").value=r(t),document.getElementById("operatingCostTblCurrentManagement").value=r(a),document.getElementById("operatingCostTblCurrentRepair").value=r(o),document.getElementById("operatingCostTblCurrentRestoration").value=r(l),document.getElementById("operatingCostTblCurrentMaintenance").value=r(c),document.getElementById("operatingCostTblCurrentNetIncome").value=r(d),document.getElementById("operatingCostTblCurrentFullRent").value=r(s),document.getElementById("operatingCostTblForecastPropertyTax").value=r(u),document.getElementById("operatingCostTblForecastManagement").value=r(p),document.getElementById("operatingCostTblForecastRepair").value=r(m),document.getElementById("operatingCostTblForecastRestoration").value=r(v),document.getElementById("operatingCostTblForecastMaintenance").value=r(g),document.getElementById("operatingCostTblForecastNetIncome").value=r(y),document.getElementById("operatingCostTblForecastFullRent").value=r(x);const h=t+a+o+l+c,f=u+p+m+v+g;document.getElementById("operatingCostTblCurrentTotalCost").value=r(h),document.getElementById("operatingCostTblForecastTotalCost").value=r(f);const b=s>0?h/s*100:0,_=x>0?f/x*100:0;document.getElementById("operatingCostTblCurrentRate").value=b.toFixed(1),document.getElementById("operatingCostTblForecastRate").value=_.toFixed(1);const T=d-h,C=y-f;document.getElementById("operatingCostTblCurrentNoi").value=r(T),document.getElementById("operatingCostTblForecastNoi").value=r(C);const E=s>0?T/s*100:0,I=x>0?C/x*100:0;document.getElementById("operatingCostTblCurrentNoiRate").value=E.toFixed(1),document.getElementById("operatingCostTblForecastNoiRate").value=I.toFixed(1);const $=document.getElementById("operatingCostCurrent"),F=document.getElementById("operatingCostForecast");$&&($.value=b.toFixed(1),$.dispatchEvent(new Event("input",{bubbles:!0}))),F&&(F.value=_.toFixed(1),F.dispatchEvent(new Event("input",{bubbles:!0})));const B=document.getElementById("noiCurrent"),w=document.getElementById("noiForecast");B&&(B.value=E.toFixed(1),B.dispatchEvent(new Event("input",{bubbles:!0}))),w&&(w.value=I.toFixed(1),w.dispatchEvent(new Event("input",{bubbles:!0})))}function d(e,t){const n=document.getElementById(`operatingCostProp_${e}_${t}_propertyTax`),a=document.getElementById(`operatingCostProp_${e}_${t}_management`),o=document.getElementById(`operatingCostProp_${e}_${t}_repair`),l=document.getElementById(`operatingCostProp_${e}_${t}_restoration`),d=document.getElementById(`operatingCostProp_${e}_${t}_maintenance`),s=document.getElementById(`operatingCostProp_${e}_${t}_netIncome`),u=document.getElementById(`operatingCostProp_${e}_${t}_fullRent`),p=document.getElementById(`operatingCostProp_${e}_${t}_totalCost`),m=document.getElementById(`operatingCostProp_${e}_${t}_noi`),v=document.getElementById(`operatingCostProp_${e}_${t}_rate`),g=document.getElementById(`operatingCostProp_${e}_${t}_noiRate`);if(!(n&&a&&o&&l&&d&&s&&u&&p&&m&&v&&g))return;const y=i(n.value),x=i(a.value),h=i(o.value),f=i(l.value),b=i(d.value),_=i(s.value),T=i(u.value),C=y+x+h+f+b,E=T>0?C/T*100:0,I=_-C,$=T>0?I/T*100:0;p.value=r(C),v.value=E.toFixed(1),m.value=r(I),g.value=$.toFixed(1),c()}a.innerHTML=`\n        <div class="form-container">\n            <table class="operating-cost-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>運営コスト率(%)</th>\n                        <th>NOI率(%)</th>\n                        <th>固都税</th>\n                        <th>管理料</th>\n                        <th>建物修繕費</th>\n                        <th>原状回復費</th>\n                        <th>メンテ経費</th>\n                        <th>実質収入</th>\n                        <th>満室賃料</th>\n                        <th>運営コスト合計</th>\n                        <th>NOI</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="operatingCostTblCurrentRate" value="0.0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNoiRate" value="0.0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentPropertyTax" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentManagement" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentRepair" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentRestoration" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentMaintenance" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNetIncome" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentFullRent" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentTotalCost" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNoi" value="0" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="operatingCostTblForecastRate" value="0.0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNoiRate" value="0.0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastPropertyTax" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastManagement" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastRepair" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastRestoration" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastMaintenance" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNetIncome" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastFullRent" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastTotalCost" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNoi" value="0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n\n            <table class="operating-cost-pivot-table">\n                <thead>\n                    <tr>\n                        <th>物件名</th>\n                        <th>現状/試算</th>\n                        <th>運営コスト率(%)</th>\n                        <th>NOI率(%)</th>\n                        <th>固都税</th>\n                        <th>管理料</th>\n                        <th>建物修繕費</th>\n                        <th>原状回復費</th>\n                        <th>メンテ経費</th>\n                        <th>実質収入</th>\n                        <th>満室賃料</th>\n                        <th>運営コスト合計</th>\n                        <th>NOI</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${o}\n                </tbody>\n            </table>\n\n            <div class="calculation-formula-container">\n                <div class="formula-content">\n                    <p>運営コスト合計 = 固都税 + 管理料 + 建物修繕費 + 原状回復費 + メンテ経費</p>\n                    <p>運営コスト率 = 運営コスト合計 ÷ 満室賃料 × 100</p>\n                    <p>NOI = 実質収入 - 運営コスト合計</p>\n                    <p>NOI率 = NOI ÷ 満室賃料 × 100</p>\n            </div>\n            </div>\n\n            \x3c!-- トップ表/チャート連携用（非表示） --\x3e\n            <input type="number" id="operatingCostCurrent" value="${t.current}" min="0" max="100" step="0.1" style="display:none;">\n            <input type="number" id="operatingCostForecast" value="${t.forecast}" min="0" max="100" step="0.1" style="display:none;">\n            \x3c!-- NOI率 連動用（非表示） --\x3e\n            <input type="number" id="noiCurrent" value="0.0" min="0" max="100" step="0.1" style="display:none;">\n            <input type="number" id="noiForecast" value="0.0" min="0" max="100" step="0.1" style="display:none;">\n        </div>\n    `;const s=document.getElementById("operatingCostTblCurrentRate");s&&(s.value=Number(t.current||0).toFixed(1));const u=document.getElementById("operatingCostTblForecastRate");return u&&(u.value=Number(t.forecast||0).toFixed(1)),setTimeout(()=>{c();const e=n.length;for(let t=0;t<e;t++)["current","forecast"].forEach(e=>{["propertyTax","management","repair","restoration","maintenance","netIncome","fullRent"].forEach(n=>{const a=document.getElementById(`operatingCostProp_${t}_${e}_${n}`);a&&l(a)}),d(t,e)});!function(){const e=n.length;for(let t=0;t<e;t++)["propertyTax","management","repair","restoration","maintenance","netIncome","fullRent"].forEach(e=>{const n=document.getElementById(`operatingCostProp_${t}_forecast_${e}`);n&&(n.addEventListener("input",e=>{l(e.target),d(t,"forecast")}),n.addEventListener("blur",e=>{l(e.target)}))})}()},0),a}let n=a({assetEfficiency:[{score:5,min:120,max:1/0},{score:4,min:100,max:120},{score:3,min:80,max:100},{score:2,min:60,max:80},{score:1,min:-1/0,max:60}],roa:[{score:5,min:8,max:1/0},{score:4,min:6,max:8},{score:3,min:4,max:6},{score:2,min:2,max:4},{score:1,min:-1/0,max:2}],incomeTax:[{score:5,min:-1/0,max:10},{score:4,min:10,max:20},{score:3,min:20,max:30},{score:2,min:30,max:40},{score:1,min:40,max:1/0}],operatingCost:[{score:5,min:-1/0,max:15},{score:4,min:15,max:20},{score:3,min:20,max:25},{score:2,min:25,max:30},{score:1,min:30,max:1/0}],noi:[{score:5,min:8,max:1/0},{score:4,min:6,max:8},{score:3,min:4,max:6},{score:2,min:2,max:4},{score:1,min:-1/0,max:2}]});function a(e){if(Array.isArray(e))return e.map(e=>a(e));if(e&&"object"==typeof e){const t={};for(const n of Object.keys(e))t[n]=a(e[n]);return t}return e}!function(){const o=kintone.$PLUGIN_ID;let r=kintone.plugin.app.getConfig(o);if("string"==typeof r)try{r=JSON.parse(r)}catch(F){r={}}if(!(r&&r.spaceId&&r.ownerAppId&&r.propertyAppId))return;let i=null,l=null,c=!1,d=!0,s=!1;function u(){!function(e){try{if(e&&e.gradeSettings){const t="string"==typeof e.gradeSettings?JSON.parse(e.gradeSettings):e.gradeSettings;Object.keys(t||{}).forEach(e=>{const a=t[e];if(!a||!Array.isArray(a.levels))return;const o="lower"===a.orientation||"higher"===a.orientation?a.orientation:"higher",r="boolean"!=typeof a.includeLower||a.includeLower,i="boolean"==typeof a.includeUpper&&a.includeUpper;function l(e,t){if(""===e||null==e)return t?-1/0:1/0;if("number"==typeof e)return isFinite(e)?e:t?-1/0:1/0;const n=String(e).trim();if(""===n)return t?-1/0:1/0;if("infinity"===n.toLowerCase()||"+Infinity"===n)return 1/0;if("-infinity"===n.toLowerCase())return-1/0;const a=Number(n);return isNaN(a)?t?-1/0:1/0:a}let c=a.levels.map(e=>{const t=l(e.min,!0),n=l(e.max,!1),a="gte"===e.minType||"gt"===e.minType?e.minType:null,o="lte"===e.maxType||"lt"===e.maxType?e.maxType:null,c=a?"gte"===a:r,d=o?"lte"===o:i;return{min:t,max:n,grade:e.grade,includeLower:c,includeUpper:d}}).filter(e=>void 0!==e.min&&void 0!==e.max);const d=c.length,s=c.map((e,t)=>{const n=parseInt(e.grade,10),a=Number.isFinite(n)&&n>0?n:null;return{score:null!=a?a:"higher"===o?t+1:d-t,min:e.min,max:e.max,includeLower:e.includeLower,includeUpper:e.includeUpper}});n[e]=s})}else if(e&&e.gradeThresholds){const t="string"==typeof e.gradeThresholds?JSON.parse(e.gradeThresholds):e.gradeThresholds;Object.keys(t||{}).forEach(e=>{if(!t[e])return;const a=[5,4,3,2,1],o=["grade5","grade4","grade3","grade2","grade1"].map((n,o)=>{var r,i;let l=parseFloat(null==(r=t[e][n])?void 0:r.min),c=parseFloat(null==(i=t[e][n])?void 0:i.max);return isNaN(l)&&(l=-1/0),isNaN(c)&&(c=1/0),{score:a[o],min:l,max:c,includeLower:!0,includeUpper:!1}});n[e]=o})}}catch(t){}}(r)}function p(){return function(){try{const e=Object.keys(n).map(e=>(Array.isArray(n[e])?n[e]:[]).reduce((e,t)=>Math.max(e,Number.isFinite(t.score)?t.score:0),0)),t=Math.max(5,...e);return isFinite(t)&&t>0?t:5}catch(F){return 5}}()}const m=["assetEfficiency","roa","incomeTax","operatingCost","noi"],v=["current","average","forecast"],g=["資産効率(%)","ROA(%)","所得税率(%)","運営コスト率(%)","NOI率(%)"],y=[{label:"現状",border:"rgb(52, 152, 219)",bgRadar:"rgba(52, 152, 219, 0.2)",bgBar:"rgba(52, 152, 219, 0.8)",bwRadar:2,bwBar:1},{label:"平均",border:"rgb(231, 76, 60)",bgRadar:"rgba(231, 76, 60, 0.2)",bgBar:"rgba(231, 76, 60, 0.8)",bwRadar:2,bwBar:1},{label:"試算",border:"rgb(46, 204, 113)",bgRadar:"rgba(46, 204, 113, 0.2)",bgBar:"rgba(46, 204, 113, 0.8)",bwRadar:2,bwBar:1}];let x={};async function h(e,t="",n=500){const a=[];let o=null,r=!0,i=0,l=0;function c(e,t,n){const a=[],o=String(e||"").trim();return o&&a.push(`(${o})`),t&&a.push(`$id > ${t}`),a.push(`order by $id asc limit ${n}`),a.join(" ")}for(;r;)try{const d={app:e,query:c(t,o,n),fields:[],totalCount:!0},s=await kintone.api("/k/v1/records.json","GET",d);s.records&&s.records.length>0?(a.push(...s.records),o=s.records[s.records.length-1].$id.value,i+=s.records.length,i%1e3==0||s.records.length,s.records.length<n&&(r=!1),l=0):r=!1}catch(d){if(console.error(`BI Dashboard Plugin: アプリ${e}のレコード取得エラー (試行${l+1}/3):`,d),l++,l>=3)console.error(`BI Dashboard Plugin: アプリ${e}のレコード取得を最大リトライ回数に達したため終了`),r=!1;else{const e=1e3*Math.pow(2,l);await new Promise(t=>setTimeout(t,e))}}return a.length,{records:a}}function f(e,t,n){var a,o,i,l,c,d,s,u,p,m,v;function g(e,t){return e&&"object"==typeof e&&null!==e&&"value"in e?e:{value:t}}function y(e){return e?{annual_rent:g(null==e?void 0:e[r.ownerAnnRent],0),annual_management_fee:g(null==e?void 0:e[r.ownerAnnMgmtFee],0),land_property_tax:g(null==e?void 0:e[r.ownerLandPropTax],0),building_property_tax:g(null==e?void 0:e[r.ownerBldgPropTax],0),long_term_repair_cost:g(null==e?void 0:e[r.ownerLongTermRepair],0),maintenance_cost:g(null==e?void 0:e[r.ownerMaint],0),loan_interest:g(null==e?void 0:e[r.ownerLoanInterest],0),depreciation:g(null==e?void 0:e[r.ownerDepreciation],0),annual_insurance_premium:g(null==e?void 0:e[r.ownerAnnInsurance],0),inheritance_tax_rate:g(void 0,0),borrowing_rate:g(void 0,0)}:null}const x=Array.isArray(e)?e.map(function(e){return{property_name:g(null==e?void 0:e[r.propertyName],""),market_price:g(null==e?void 0:e[r.propMarketPrice],0),income:g(null==e?void 0:e[r.propIncome],0),inheritance_tax_value:g(null==e?void 0:e[r.propInheritanceTaxVal],0),property_tax:g(null==e?void 0:e[r.propPropTax],0),management_fee:g(null==e?void 0:e[r.propMgmtFee],0),building_repair_cost:g(null==e?void 0:e[r.propBldgRepair],0),restoration_cost:g(null==e?void 0:e[r.propRestoration],0),maintenance_cost:g(null==e?void 0:e[r.propMaint],0),net_income:g(null==e?void 0:e[r.propNetIncome],0),full_rent:g(null==e?void 0:e[r.propFullRent],0)}}):[],h=Array.isArray(t)&&t.length>0?y(t[0]):null;try{x[0]}catch(F){}let f=0,b=0,_=0,T=0,C=0,E=0;x.forEach(e=>{var t,n,a,o,r,i,l,c,d,s,u,p;f+=parseFloat((null==(t=e.market_price)?void 0:t.value)||0),b+=parseFloat((null==(n=e.income)?void 0:n.value)||0),T+=parseFloat((null==(a=e.inheritance_tax_value)?void 0:a.value)||0);const m=parseFloat((null==(o=e.property_tax)?void 0:o.value)||0)+parseFloat((null==(r=e.management_fee)?void 0:r.value)||0)+parseFloat((null==(i=e.building_repair_cost)?void 0:i.value)||0)+parseFloat((null==(l=e.restoration_cost)?void 0:l.value)||0)+parseFloat((null==(c=e.maintenance_cost)?void 0:c.value)||0);C+=m;const v=parseFloat((null==(d=e.full_rent)?void 0:d.value)||0);E+=v;const g=parseFloat((null==(s=e.net_income)?void 0:s.value)||0);_+=g,parseFloat((null==(u=e.income)?void 0:u.value)||0),parseFloat((null==(p=e.inheritance_tax_value)?void 0:p.value)||0)});const I=function(e){const{owners:t,properties:n}=e,a={};n.forEach(e=>{var t;const n=null==(t=e[r.propertyOwnerId])?void 0:t.value;n&&(a[n]||(a[n]=[]),a[n].push(e))});const o=[];t.forEach(e=>{var t,n,i,l,c,d,s,u,p,m,v,g;const x=null==(t=e[r.ownerId])?void 0:t.value;if(!x)return;const h=a[x]||[];if(0===h.length)return;let f=0,b=0,_=0,T=0,C=0;h.forEach(e=>{var t,n,a,o,i,l,c,d,s;const u=parseFloat((null==(t=e[r.propIncome])?void 0:t.value)||0),p=parseFloat((null==(n=e[r.propInheritanceTaxVal])?void 0:n.value)||0),m=parseFloat((null==(a=e[r.propFullRent])?void 0:a.value)||0),v=parseFloat((null==(o=e[r.propNetIncome])?void 0:o.value)||0),g=parseFloat((null==(i=e[r.propPropTax])?void 0:i.value)||0)+parseFloat((null==(l=e[r.propMgmtFee])?void 0:l.value)||0)+parseFloat((null==(c=e[r.propBldgRepair])?void 0:c.value)||0)+parseFloat((null==(d=e[r.propRestoration])?void 0:d.value)||0)+parseFloat((null==(s=e[r.propMaint])?void 0:s.value)||0);f+=u,b+=v,_+=p,T+=g,C+=m});const E=_>0?f/_*100:0,I=C>0?T/C*100:0;let $=0;h.forEach(e=>{var t;const n=parseFloat((null==(t=e[r.propMarketPrice])?void 0:t.value)||0);$+=n});const F=_>0?$/_*100:0,B=C>0?(b-T)/C*100:0,w=y(e);let R=0;if(w){const e=parseFloat((null==(n=w.annual_management_fee)?void 0:n.value)||0)+parseFloat((null==(i=w.land_property_tax)?void 0:i.value)||0)+parseFloat((null==(l=w.building_property_tax)?void 0:l.value)||0)+parseFloat((null==(c=w.long_term_repair_cost)?void 0:c.value)||0)+parseFloat((null==(d=w.maintenance_cost)?void 0:d.value)||0)+parseFloat((null==(s=w.loan_interest)?void 0:s.value)||0)+parseFloat((null==(u=w.depreciation)?void 0:u.value)||0)+parseFloat((null==(p=w.annual_insurance_premium)?void 0:p.value)||0);R=parseFloat((null==(m=w.annual_rent)?void 0:m.value)||0)-e}let P=0;R>4e7?P=45:R>18e6?P=40:R>9e6?P=33:R>695e4?P=23:R>33e5?P=20:R>195e4?P=10:R>0&&(P=5);const k=y(e),M=parseFloat((null==(v=null==k?void 0:k.inheritance_tax_rate)?void 0:v.value)||0),L=parseFloat((null==(g=null==k?void 0:k.borrowing_rate)?void 0:g.value)||0);o.push({assetEfficiency:F,roa:E,operatingCostRate:I,incomeTaxRate:P,inheritanceTaxRate:M,borrowingRate:L,noiRate:B})});const i={assetEfficiency:0,roa:0,operatingCost:0,incomeTax:0,inheritanceTax:0,borrowing:0,noi:0};if(o.length>0){const e=o.reduce((e,t)=>(e.assetEfficiency+=t.assetEfficiency,e.roa+=t.roa,e.operatingCost+=t.operatingCostRate,e.incomeTax+=t.incomeTaxRate,e.inheritanceTax+=t.inheritanceTaxRate,e.borrowing+=t.borrowingRate,e.noi+=t.noiRate,e),{assetEfficiency:0,roa:0,operatingCost:0,incomeTax:0,inheritanceTax:0,borrowing:0,noi:0}),t=o.length;i.assetEfficiency=e.assetEfficiency/t,i.roa=e.roa/t,i.operatingCost=e.operatingCost/t,i.incomeTax=e.incomeTax/t,i.inheritanceTax=e.inheritanceTax/t,i.borrowing=e.borrowing/t,i.noi=e.noi/t}return i}(n||{owners:[],properties:[]}),$=T>0?b/T*100:0,B=E>0?C/E*100:0,w=T>0?f/T*100:0,R=E>0?(_-C)/E*100:0;let P=0,k=0,M=0;if(h){const e=parseFloat((null==(a=h.annual_management_fee)?void 0:a.value)||0)+parseFloat((null==(o=h.land_property_tax)?void 0:o.value)||0)+parseFloat((null==(i=h.building_property_tax)?void 0:i.value)||0)+parseFloat((null==(l=h.long_term_repair_cost)?void 0:l.value)||0)+parseFloat((null==(c=h.maintenance_cost)?void 0:c.value)||0)+parseFloat((null==(d=h.loan_interest)?void 0:d.value)||0)+parseFloat((null==(s=h.depreciation)?void 0:s.value)||0)+parseFloat((null==(u=h.annual_insurance_premium)?void 0:u.value)||0);P=parseFloat((null==(p=h.annual_rent)?void 0:p.value)||0)-e,k=parseFloat((null==(m=h.inheritance_tax_rate)?void 0:m.value)||0),M=parseFloat((null==(v=h.borrowing_rate)?void 0:v.value)||0)}let L=0;return P>4e7?L=45:P>18e6?L=40:P>9e6?L=33:P>695e4?L=23:P>33e5?L=20:P>195e4?L=10:P>0&&(L=5),{assetEfficiency:{current:w,average:I.assetEfficiency,forecast:w},roa:{current:$,average:I.roa,forecast:$},incomeTax:{current:L,average:I.incomeTax,forecast:L},inheritanceTax:{current:k,average:I.inheritanceTax,forecast:k},borrowing:{current:M,average:I.borrowing,forecast:M},operatingCost:{current:B,average:I.operatingCost,forecast:B},noi:{current:R,average:I.noi,forecast:R},propertyDetails:x,ownerDetails:h,calculatedIncomeTaxable:P,calculatedIncomeTaxRate:L}}function b(e){return e.charAt(0).toUpperCase()+e.slice(1)}function _(){document.querySelectorAll("#dataTable tbody tr").forEach((e,t)=>{const n=m[t];if(!n||!x[n])return;const a=x[n],o=e.querySelectorAll("td");o.length<4||(o[1].textContent=a.current.toFixed(1),o[2].textContent=s?"集計中":a.average.toFixed(1),o[3].textContent=a.forecast.toFixed(1))})}function T(e,t=x){try{if(d){const a=m.map(a=>{if(!t[a])return console.warn(`Missing data for metric: ${a}`),1;const o=t[a][e];return null==o?(console.warn(`Missing value for ${a}.${e}:`,o),1):function(e,t){const a=n[e];if(!a)return 1;const o=parseFloat(t);if(isNaN(o))return 1;for(const n of a){const e="boolean"!=typeof n.includeLower||n.includeLower,t="boolean"==typeof n.includeUpper&&n.includeUpper,a=e?o>=n.min:o>n.min,r=t?o<=n.max:o<n.max;if(a&&r)return Number(n.score)||1}return 1}(a,o)});return a}return c?m.map(n=>{if(!t[n])return console.warn(`Missing data for metric: ${n}`),0;const a=parseFloat(t[n].average)||0,o=parseFloat(t[n].current)||0,r=parseFloat(t[n].forecast)||0;return"current"===e?a>0?o/a:0:"forecast"===e?a>0?r/a:0:1}):m.map(n=>t[n]&&null!==t[n][e]&&void 0!==t[n][e]?parseFloat(t[n][e])||0:(console.warn(`Missing value for ${n}.${e}`),0))}catch(a){return console.error("Error in getChartValues:",a),m.map(()=>d?1:0)}}function C(){try{$(),v.forEach((e,t)=>{const n=T(e);if(n&&Array.isArray(n)&&n.length===m.length){const e=n.map(e=>Number(e)||0);i&&i.data&&i.data.datasets&&i.data.datasets[t]&&(i.data.datasets[t].data=e),l&&l.data&&l.data.datasets&&l.data.datasets[t]&&(l.data.datasets[t].data=e)}else console.warn(`Invalid chart values for field ${e}:`,n)}),i&&i.update&&i.update(),l&&l.update&&l.update()}catch(e){console.error("Error updating charts:",e)}}function E(e,t){if(""===e||null==e)return t?-1/0:1/0;const n=Number(e);return isNaN(n)?t?-1/0:1/0:n}function I(e){return e===1/0?"∞":e===-1/0?"-∞":"number"!=typeof e?String(e??""):Number.isInteger(e)?String(e):e.toFixed(2)}function $(){try{if(d){const e=p();i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=e,i.options.scales.r.min=0,i.options.scales.r.beginAtZero=!0,i.options.scales.r.ticks||(i.options.scales.r.ticks={}),i.options.scales.r.ticks.suggestedMin=0,i.options.scales.r.ticks.stepSize=1),l&&l.options&&l.options.scales&&l.options.scales.y&&(l.options.scales.y.max=e,l.options.scales.y.min=0,l.options.scales.y.beginAtZero=!0,l.options.scales.y.ticks||(l.options.scales.y.ticks={}),l.options.scales.y.ticks.suggestedMin=0,l.options.scales.y.ticks.stepSize=1)}else if(c){const e=Math.max(...m.map(e=>{const t=x[e].current,n=x[e].forecast,a=x[e].average,o=a>0?t/a:0,r=a>0?n/a:0;return Math.max(o,r,1)})),t=Math.min(...m.map(e=>{const t=x[e].current,n=x[e].forecast,a=x[e].average,o=a>0?t/a:0,r=a>0?n/a:0;return Math.min(o,r,1)})),n=Math.max(e-1,1-t),a=Math.max(.2*n,.2),o=1+n+a,r=Math.max(1-n-a,0);i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=o,i.options.scales.r.min=r,i.options.scales.r.beginAtZero=!1),l&&l.options&&l.options.scales&&l.options.scales.y&&(l.options.scales.y.max=o,l.options.scales.y.min=r,l.options.scales.y.beginAtZero=!1)}else if(i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=100,i.options.scales.r.min=0,i.options.scales.r.beginAtZero=!0),l&&l.options&&l.options.scales&&l.options.scales.y){const e=Math.max(...m.map(e=>{const t=parseFloat(x[e].current)||0,n=parseFloat(x[e].forecast)||0,a=parseFloat(x[e].average)||0;return Math.max(t,n,a)})),t=Math.min(...m.map(e=>{const t=parseFloat(x[e].current)||0,n=parseFloat(x[e].forecast)||0,a=parseFloat(x[e].average)||0;return Math.min(t,n,a)})),n=Math.max(.1*(e-t),5),a=e+n,o=Math.max(t-n,0);l.options.scales.y.max=a,l.options.scales.y.min=o,l.options.scales.y.beginAtZero=0===o}}catch(e){console.error("Error updating chart scales:",e)}}kintone.events.on(["app.record.detail.show","app.record.edit.show","app.record.create.show"],function(o){return setTimeout(()=>{const p=kintone.app.record.getSpaceElement(r.spaceId);p?async function(o,p){var B,w,R,P,k;try{!function(e){e.innerHTML='\n      <div class="loading-container" style="\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 40px;\n        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n      ">\n        <div class="loading-spinner" style="\n          width: 40px;\n          height: 40px;\n          border: 4px solid #f3f3f3;\n          border-top: 4px solid #3498db;\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n          margin-bottom: 16px;\n        "></div>\n        <div class="loading-text" style="\n          color: #666;\n          font-size: 14px;\n          text-align: center;\n        ">データを読み込み中...</div>\n        <style>\n          @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n        </style>\n      </div>\n    '}(o),u();const L=r.propertyAppId,N=r.ownerAppId,A=p&&r.currentAppOwnerId&&(null==(B=p[r.currentAppOwnerId])?void 0:B.value)||"",S={};async function D(e,t,n){if(!e)return{records:[]};const a=/^-?\d+(?:\.\d+)?$/.test(String(n||"").trim());if(t&&""!==n&&null!=n){try{const a=await kintone.api("/k/v1/records.json","GET",{app:e,query:`${t} = "${n}"`});if(Array.isArray(a.records)&&a.records.length>0)return a}catch(o){}if(a)try{const a=await kintone.api("/k/v1/records.json","GET",{app:e,query:`${t} = ${n}`});if(Array.isArray(a.records)&&a.records.length>0)return a}catch(o){}}try{return await h(e)}catch(o){return{records:[]}}}async function O(){var e,t;try{const n=await async function(e,t={},n=500,a="offset",o=5){const r="offset"===String(a||"offset").toLowerCase(),i=e.map(e=>{const a=t[e]||"";return r?async function(e,t="",n=500,a=5){function o(e,t,n){const a=[],o=String(e||"").trim();return o&&a.push(`(${o})`),a.push(`order by $id asc limit ${t} offset ${n}`),a.join(" ")}let r=0;try{const n={app:e,query:o(t,1,0),totalCount:!0,fields:[]},a=await kintone.api("/k/v1/records.json","GET",n);r=Number(a.totalCount||0)}catch(F){}if(!r||!isFinite(r)||r<0)return h(e,t,n);const i=[];for(let c=0;c<r;c+=n)i.push(c);const l=[];for(let c=0;c<i.length;c+=a){const r=i.slice(c,c+a).map(a=>{const r={app:e,query:o(t,n,a),totalCount:!1,fields:[]};return kintone.api("/k/v1/records.json","GET",r).then(e=>e.records||[])});(await Promise.all(r)).forEach(e=>{l.push(...e)}),await new Promise(e=>setTimeout(e,100))}return{records:l}}(e,a,n,o):h(e,a,n)}),l=await Promise.all(i),c={};return e.forEach((e,t)=>{c[e]=l[t]}),c}([N,L],{},500,"offset",5);return{owners:(null==(e=n[N])?void 0:e.records)||[],properties:(null==(t=n[L])?void 0:t.records)||[]}}catch(n){return console.error("全オーナーデータの取得に失敗:",n),{owners:[],properties:[]}}}A&&r.propertyOwnerId&&(S[L]=`${r.propertyOwnerId} = "${A}"`),A&&r.ownerId&&(S[N]=`${r.ownerId} = "${A}"`),s=!0;const[q,U]=await Promise.all([D(L,r.propertyOwnerId,A),D(N,r.ownerId,A)]);try{r.ownerId,r.propertyOwnerId,null==(w=q.records)||w.length,null==(R=U.records)||R.length,null==(P=allOwnersData.owners)||P.length,null==(k=allOwnersData.properties)||k.length}catch(F){}const j=f(q.records,U.records,{owners:[],properties:[]});x=j,function(o,u){!function(n,a){n.innerHTML="",n.classList.add("bi-dashboard-plugin");const o=document.createElement("div");o.className="container";const r=document.createElement("div");r.className="top-section",r.appendChild(function(e){const t=document.createElement("div");t.className="table-section";const n=g.map((t,n)=>{const a=m[n],o=e[a],r=s?"集計中":o.average.toFixed(1);return`<tr>\n            <td>${t}</td>\n            <td>${o.current.toFixed(1)}</td>\n            <td>${r}</td>\n            <td>${o.forecast.toFixed(1)}</td>\n        </tr>`}).join("");return t.innerHTML=`\n        <div class="table-container">\n            <table id="dataTable">\n                <thead>\n                    <tr>\n                        <th>項目名</th>\n                        <th>現状</th>\n                        <th>平均</th>\n                        <th>試算</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${n}\n                </tbody>\n            </table>\n        </div>\n    `,t}(a)),r.appendChild(function(){const e=document.createElement("div");return e.className="chart-section",e.innerHTML='\n        <div class="chart-container">\n            <div class="chart-controls">\n                <button class="chart-toggle-button active" data-chart="radar">レーダーチャート</button>\n                <button class="chart-toggle-button" data-chart="bar">棒グラフ</button>\n                <div class="compression-control">\n                    <input type="checkbox" id="compressionCheckbox" class="compression-checkbox">\n                    <label for="compressionCheckbox">平均を1として比較する</label>\n                </div>\n                <div class="grade-control">\n                    <input type="checkbox" id="gradeCheckbox" class="grade-checkbox" checked>\n                    <label for="gradeCheckbox">成績で表示する</label>\n                </div>\n                <button class="grade-info-button" title="成績基準を表示">ℹ</button>\n            </div>\n            <div class="chart-item">\n                <div id="radarChartContainer">\n                    <h3>財務指標レーダーチャート</h3>\n                    <div class="chart-canvas-wrap"><canvas id="radarChart"></canvas></div>\n                </div>\n                <div id="barChartContainer" style="display: none;">\n                    <h3>財務指標棒グラフ</h3>\n                    <div class="chart-canvas-wrap"><canvas id="barChart"></canvas></div>\n                </div>\n            </div>\n        </div>\n    ',e}());const i=document.createElement("div");i.className="bottom-section";const l=function(){const e=document.createElement("div");e.className="tabs";const t=[{key:"roa",label:"資産効率・ROA",active:!0},{key:"operatingCost",label:"運営コスト率・NOI"},{key:"incomeTax",label:"所得税率"}];return e.innerHTML=t.map(e=>`\n        <button class="tab-button${e.active?" active":""}" data-tab="${e.key}">${e.label}</button>\n    `).join(""),e}();i.appendChild(l);const c=e(a);c.id="roaTab";const d=t(a);d.id="operatingCostTab";const u=function(e){var t,n,a,o,r,i,l,c,d;const{incomeTax:s,ownerDetails:u,calculatedIncomeTaxable:p,calculatedIncomeTaxRate:m}=e,v=document.createElement("div");function g(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function y(e){return parseFloat(e.replace(/,/g,""))||0}function x(e){const t=e.value.replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,o=g(t);if(a!==o){e.value=o;const t=(a.match(/,/g)||[]).length,r=n+((o.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(r,o.length)),Math.max(0,Math.min(r,o.length)))}}}function h(e,t){const n=[{rate:5,min:0,max:195e4},{rate:10,min:1950001,max:33e5},{rate:20,min:3300001,max:695e4},{rate:23,min:6950001,max:9e6},{rate:33,min:9000001,max:18e6},{rate:40,min:18000001,max:4e7},{rate:45,min:40000001,max:1/0}];let a=n.findIndex(t=>e>=t.min&&e<=t.max);if(-1===a&&(a=n.findIndex(e=>e.rate===t)),-1===a)return{lowerDiff:"0円",upperDiff:"0円"};const o=a>0?n[a-1]:null,r=a<n.length-1?n[a+1]:null,i=o?Math.max(0,e-o.max):0,l=r?Math.max(0,r.min-e):0;return{lowerDiff:g(i)+"円",upperDiff:g(l)+"円"}}function f(){const e=y(document.getElementById("incomeTaxCurrentIncome").value),t=parseInt(document.getElementById("incomeTaxCurrentTaxRate").value)||0,n=y(document.getElementById("incomeTaxForecastIncome").value),a=parseInt(document.getElementById("incomeTaxForecastTaxRate").value)||0;document.getElementById("currentIncomeDisplay").textContent=g(e)+"円",document.getElementById("currentRateDisplay").textContent=t+"%";const o=h(e,t);document.getElementById("currentLowerAmount").textContent=o.lowerDiff,document.getElementById("currentUpperAmount").textContent=o.upperDiff,document.getElementById("forecastIncomeDisplay").textContent=g(n)+"円",document.getElementById("forecastRateDisplay").textContent=a+"%";const r=h(n,a);document.getElementById("forecastLowerAmount").textContent=r.lowerDiff,document.getElementById("forecastUpperAmount").textContent=r.upperDiff}function b(){document.querySelectorAll(".tax-rate-table tbody tr").forEach(e=>{e.classList.remove("highlighted-current","highlighted-forecast")});const e=parseInt(document.getElementById("incomeTaxCurrentTaxRate").value)||0,t=parseInt(document.getElementById("incomeTaxForecastTaxRate").value)||0;if(e>0){const t=document.querySelector(`.tax-rate-table tbody tr[data-rate="${e}"]`);t&&t.classList.add("highlighted-current")}if(t>0){const e=document.querySelector(`.tax-rate-table tbody tr[data-rate="${t}"]`);e&&e.classList.add("highlighted-forecast")}}function _(e){const t=y(document.getElementById(`incomeTax${e}Rent`).value)-(y(document.getElementById(`incomeTax${e}Management`).value)+y(document.getElementById(`incomeTax${e}LandTax`).value)+y(document.getElementById(`incomeTax${e}BuildingTax`).value)+y(document.getElementById(`incomeTax${e}Repair`).value)+y(document.getElementById(`incomeTax${e}Maintenance`).value)+y(document.getElementById(`incomeTax${e}Interest`).value)+y(document.getElementById(`incomeTax${e}Depreciation`).value)+y(document.getElementById(`incomeTax${e}Insurance`).value)),n=function(e){return e<=0?0:e<=195e4?5:e<=33e5?10:e<=695e4?20:e<=9e6?23:e<=18e6?33:e<=4e7?40:45}(t);document.getElementById(`incomeTax${e}Income`).value=g(t),document.getElementById(`incomeTax${e}TaxRate`).value=n;const a={rowType:e,taxRate:n};if(document.dispatchEvent(new CustomEvent("incomeTax:taxRateUpdated",{detail:a})),window&&"function"==typeof window.setIncomeTaxRate)try{window.setIncomeTaxRate(e.toLowerCase(),n)}catch(F){}b(),f()}return v.className="tab-content",v.dataset.tab="incomeTax",v.innerHTML=`\n        <div class="form-container">\n            <table class="roa-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>年賃料</th>\n                        <th>年管理費</th>\n                        <th>土地固都税</th>\n                        <th>建物固都税</th>\n                        <th>長期修繕計画経費</th>\n                        <th>メンテナンス経費</th>\n                        <th>借入金利息</th>\n                        <th>減価償却費</th>\n                        <th>保険料年額</th>\n                        <th>所得税課税所得</th>\n                        <th>所得税率</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="incomeTaxCurrentRent" value="${(null==(t=null==u?void 0:u.annual_rent)?void 0:t.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentManagement" value="${(null==(n=null==u?void 0:u.annual_management_fee)?void 0:n.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentLandTax" value="${(null==(a=null==u?void 0:u.land_property_tax)?void 0:a.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentBuildingTax" value="${(null==(o=null==u?void 0:u.building_property_tax)?void 0:o.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentRepair" value="${(null==(r=null==u?void 0:u.long_term_repair_cost)?void 0:r.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentMaintenance" value="${(null==(i=null==u?void 0:u.maintenance_cost)?void 0:i.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentInterest" value="${(null==(l=null==u?void 0:u.loan_interest)?void 0:l.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentDepreciation" value="${(null==(c=null==u?void 0:u.depreciation)?void 0:c.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentInsurance" value="${(null==(d=null==u?void 0:u.annual_insurance_premium)?void 0:d.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentIncome" value="${p||0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentTaxRate" value="${m||0}" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="incomeTaxForecastRent" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastManagement" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastLandTax" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastBuildingTax" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastRepair" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastMaintenance" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastInterest" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastDepreciation" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastInsurance" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastIncome" value="0" readonly></td>\n                        <td><input type="text" id="incomeTaxForecastTaxRate" value="0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n        \n        <div class="calculation-formula-container">\n            <div class="formula-content">\n                <p>課税所得 = 年賃料 - (年管理費 + 土地固都税 + 建物固都税 + 長期修繕計画経費 + メンテナンス経費 + 借入金利息 + 減価償却費 + 保険料年額)</p>\n            </div>\n        </div>\n        \n        <div class="tax-info-container">\n            <div class="tax-rate-table-container">\n                <table class="tax-rate-table">\n                    <thead>\n                        <tr>\n                            <th>課税所得</th>\n                            <th>税率</th>\n                            <th>控除額</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <tr data-rate="5">\n                            <td>0円から1,950,000円まで</td>\n                            <td>5%</td>\n                            <td>0円</td>\n                        </tr>\n                        <tr data-rate="10">\n                            <td>1,950,001円から3,300,000円まで</td>\n                            <td>10%</td>\n                            <td>97,500円</td>\n                        </tr>\n                        <tr data-rate="20">\n                            <td>3,300,001円から6,950,000円まで</td>\n                            <td>20%</td>\n                            <td>427,500円</td>\n                        </tr>\n                        <tr data-rate="23">\n                            <td>6,950,001円から9,000,000円まで</td>\n                            <td>23%</td>\n                            <td>636,000円</td>\n                        </tr>\n                        <tr data-rate="33">\n                            <td>9,000,001円から18,000,000円まで</td>\n                            <td>33%</td>\n                            <td>1,536,000円</td>\n                        </tr>\n                        <tr data-rate="40">\n                            <td>18,000,001円から40,000,000円まで</td>\n                            <td>40%</td>\n                            <td>2,796,000円</td>\n                        </tr>\n                        <tr data-rate="45">\n                            <td>40,000,001円から</td>\n                            <td>45%</td>\n                            <td>4,796,000円</td>\n                        </tr>\n                    </tbody>\n                </table>\n            </div>\n            \n            <div class="tax-difference-container">\n                <div class="difference-info">\n                    <div class="current-info">\n                        <h5>現状値</h5>\n                        <div id="currentDifferenceInfo">\n                            <p>課税所得: <span id="currentIncomeDisplay">0円</span></p>\n                            <p>適用税率: <span id="currentRateDisplay">0%</span></p>\n                            <p id="currentLowerDiff">一つ下の税率まで: <span id="currentLowerAmount">-</span></p>\n                            <p id="currentUpperDiff">一つ上の税率まで: <span id="currentUpperAmount">-</span></p>\n                        </div>\n                    </div>\n                    <div class="forecast-info">\n                        <h5>試算値</h5>\n                        <div id="forecastDifferenceInfo">\n                            <p>課税所得: <span id="forecastIncomeDisplay">0円</span></p>\n                            <p>適用税率: <span id="forecastRateDisplay">0%</span></p>\n                            <p id="forecastLowerDiff">一つ下の税率まで: <span id="forecastLowerAmount">-</span></p>\n                            <p id="forecastUpperDiff">一つ上の税率まで: <span id="forecastUpperAmount">-</span></p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `,setTimeout(()=>{["incomeTaxCurrentRent","incomeTaxCurrentManagement","incomeTaxCurrentLandTax","incomeTaxCurrentBuildingTax","incomeTaxCurrentRepair","incomeTaxCurrentMaintenance","incomeTaxCurrentInterest","incomeTaxCurrentDepreciation","incomeTaxCurrentInsurance","incomeTaxCurrentIncome","incomeTaxCurrentTaxRate"].forEach(e=>{const t=document.getElementById(e);t&&x(t)});const e=document.getElementById("incomeTaxCurrentIncome").value,t=document.getElementById("incomeTaxCurrentTaxRate").value;"0"===e&&"0"===t?_("Current"):(b(),f()),["Rent","Management","LandTax","BuildingTax","Repair","Maintenance","Interest","Depreciation","Insurance"].forEach(e=>{const t=document.getElementById(`incomeTaxCurrent${e}`),n=document.getElementById(`incomeTaxForecast${e}`);t&&n&&(n.value=t.value)});const n=document.getElementById("incomeTaxCurrentIncome"),a=document.getElementById("incomeTaxCurrentTaxRate"),o=document.getElementById("incomeTaxForecastIncome"),r=document.getElementById("incomeTaxForecastTaxRate");n&&o&&(o.value=n.value),a&&r&&(r.value=a.value),["incomeTaxForecastRent","incomeTaxForecastManagement","incomeTaxForecastLandTax","incomeTaxForecastBuildingTax","incomeTaxForecastRepair","incomeTaxForecastMaintenance","incomeTaxForecastInterest","incomeTaxForecastDepreciation","incomeTaxForecastInsurance","incomeTaxForecastIncome","incomeTaxForecastTaxRate"].forEach(e=>{const t=document.getElementById(e);t&&x(t)}),_("Forecast"),["incomeTaxForecastRent","incomeTaxForecastManagement","incomeTaxForecastLandTax","incomeTaxForecastBuildingTax","incomeTaxForecastRepair","incomeTaxForecastMaintenance","incomeTaxForecastInterest","incomeTaxForecastDepreciation","incomeTaxForecastInsurance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{x(e.target),_("Forecast")}),t.addEventListener("blur",e=>{x(e.target)}))})},200),v}(a);u.id="incomeTaxTab";const p=function(){const e=document.createElement("div");return e.className="tab-content",e.dataset.tab="inheritanceTax",e.innerHTML='\n        <div class="form-container">\n            <div class="unimplemented-message">\n                <h3>未実装</h3>\n                <p>機能追加のご依頼をお待ちしております。<br>ほっとビジネスサポート(株)</p>\n            </div>\n        </div>\n    ',e}(a.inheritanceTax);p.id="inheritanceTaxTab";const v=function(){const e=document.createElement("div");return e.className="tab-content",e.dataset.tab="borrowing",e.innerHTML='\n        <div class="form-container">\n            <div class="unimplemented-message">\n                <h3>未実装</h3>\n                <p>機能追加のご依頼をお待ちしております。<br>ほっとビジネスサポート(株)</p>\n            </div>\n        </div>\n    ',e}(a.borrowing);v.id="borrowingTab",i.appendChild(c),i.appendChild(d),i.appendChild(u),i.appendChild(p),i.appendChild(v),o.appendChild(r),o.appendChild(i),n.appendChild(o)}(o,u);const p=o.querySelector(".container");(function(e){if(!e)return;requestAnimationFrame(()=>{e.style.width="1400px",e.style.minWidth="1400px",e.style.maxWidth="1400px",e.style.boxSizing="border-box"})})(p),function(e){try{const t=document.getElementById("radarChart"),n=document.getElementById("barChart");if(!t||!n)return void console.error("Chart canvas elements not found");const a=t.getContext("2d"),o=n.getContext("2d"),r=v.map((t,n)=>{const a=T(t,e);return{label:String(y[n].label),data:a.map(e=>Number(e)||0),borderColor:String(y[n].border),backgroundColor:String(y[n].bgRadar),borderWidth:Number(y[n].bwRadar),hidden:!("average"!==t||!s)}}),c=v.map((t,n)=>{const a=T(t,e);return{label:String(y[n].label),data:a.map(e=>Number(e)||0),backgroundColor:String(y[n].bgBar),borderColor:String(y[n].border),borderWidth:Number(y[n].bwBar),hidden:!("average"!==t||!s)}});i=new Chart(a,{type:"radar",data:{labels:g.map(e=>String(e)),datasets:r},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{r:{beginAtZero:!0,max:100,min:0,type:"radialLinear"}},plugins:{legend:{position:"bottom"}}}}),l=new Chart(o,{type:"bar",data:{labels:g.map(e=>String(e)),datasets:c},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{y:{beginAtZero:!0,max:100,min:0,type:"linear"}},plugins:{legend:{position:"bottom"}}}}),$()}catch(t){console.error("Error initializing charts:",t),console.error("Error stack:",t.stack)}}(u),document.querySelectorAll('input[type="number"]').forEach(e=>{e.addEventListener("input",function(){const e=function(e){for(const t of v){const n=b(t);if(e.endsWith(n)){const a=e.slice(0,-n.length);if(m.includes(a))return{metric:a,field:t}}}return null}(this.id);if(!e)return;const{metric:t,field:n}=e;x[t][n]=parseFloat(this.value)||0,_(),C()})}),function(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{!function(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`.tab-content[data-tab="${e}"]`)||document.getElementById(`${e}Tab`),n=document.querySelector(`.tab-button[data-tab="${e}"]`);t&&t.classList.add("active");n&&n.classList.add("active")}(e.dataset.tab)})}),document.querySelectorAll(".chart-toggle-button").forEach(e=>{e.addEventListener("click",()=>{!function(e){document.querySelectorAll(".chart-toggle-button").forEach(e=>e.classList.remove("active"));const t=document.getElementById("radarChartContainer"),n=document.getElementById("barChartContainer");if(!t||!n)return;if(t.style.display="none",n.style.display="none","radar"===e){t.style.display="block";const e=document.querySelector('.chart-toggle-button[data-chart="radar"]');e&&e.classList.add("active"),requestAnimationFrame(()=>{i&&i.resize()})}else{n.style.display="block";const e=document.querySelector('.chart-toggle-button[data-chart="bar"]');e&&e.classList.add("active"),requestAnimationFrame(()=>{l&&l.resize()})}}(e.dataset.chart)})}),document.querySelectorAll(".compression-checkbox").forEach(e=>{e.addEventListener("change",()=>{!function(){const e=document.querySelector(".compression-checkbox");e&&(c=e.checked);if(c){const e=document.querySelector(".grade-checkbox");e&&(e.checked=!1),d=!1}$(),C()}()})}),document.querySelectorAll(".grade-checkbox").forEach(e=>{e.addEventListener("change",()=>{!function(){const e=document.querySelector(".grade-checkbox");e&&(d=e.checked);if(d){const e=document.querySelector(".compression-checkbox");e&&(e.checked=!1),c=!1}$(),C()}()})});const e=document.querySelector(".grade-info-button");e&&e.addEventListener("click",()=>{!function(){var e;try{const t=function(){const e={},t=function(){try{return a(n)}catch(F){try{return function(e){const t={};return["assetEfficiency","roa","incomeTax","operatingCost","noi"].forEach(n=>{const a=null==e?void 0:e[n];if(!a||!Array.isArray(a.levels))return;const o="boolean"!=typeof a.includeLower||a.includeLower,r="boolean"==typeof a.includeUpper&&a.includeUpper;t[n]=a.levels.map(e=>({score:parseInt(e.grade,10)||"",min:E(e.min,!0),max:E(e.max,!1),includeLower:"gte"===e.minType||"gt"!==e.minType&&o,includeUpper:"lte"===e.maxType||"lt"!==e.maxType&&r}))}),t}("string"==typeof(null==r?void 0:r.gradeSettings)?JSON.parse(r.gradeSettings):(null==r?void 0:r.gradeSettings)||{})}catch(e){return{}}}}();return Object.keys(t).forEach(n=>{const a=Array.isArray(t[n])?t[n]:[];e[n]=a.map(e=>({gradeLabel:String(e.score??""),min:e.min,max:e.max,includeLower:Boolean(e.includeLower),includeUpper:Boolean(e.includeUpper)}))}),e}(),o=document.createElement("div");o.className="grade-info-overlay",o.innerHTML=`\n        <div class="grade-info-modal">\n          <div class="grade-info-header">\n            <h3>成績基準一覧</h3>\n            <button class="grade-info-close" aria-label="閉じる">×</button>\n          </div>\n          <div class="grade-info-body">\n            ${function(e){const t={assetEfficiency:"資産効率(%)",roa:"ROA(%)",incomeTax:"所得税率(%)",operatingCost:"運営コスト率(%)",noi:"NOI率(%)"},n='<div class="grade-info-legend">\n      <p>上から順に適用されます。区間表記は [ を「含む」、( を「含まない」、] を「含む」、) を「含まない」と表します。</p>\n      <p>例: [10, 20) は「10以上 20未満」を意味します。</p>\n    </div>',a=Object.keys(e).map(n=>{const a=e[n].map(e=>{const t=function(e,t,n,a){const o=a?"]":")";return`${n?"[":"("}${I(e)}, ${I(t)}${o}`}(e.min,e.max,e.includeLower,e.includeUpper),n=function(e,t,n,a){const o=t?"以上":"超過",r=a?"以下":"未満",i=e===-1/0,l=n===1/0;return i&&l?"制限なし":i?`${I(n)}${r}`:l?`${I(e)}${o}`:`${I(e)}${o} かつ ${I(n)}${r}`}(e.min,e.includeLower,e.max,e.includeUpper);return`<tr>\n          <td><span class="grade-badge">${a=e.gradeLabel,String(a??"").replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}</span></td>\n          <td>${t}</td>\n          <td>${n}</td>\n        </tr>`;var a}).join("");return`<div class="grade-info-section">\n        <h4>${t[n]||n}</h4>\n        <table class="grade-info-table">\n          <thead><tr><th>成績</th><th>区間</th><th>条件</th></tr></thead>\n          <tbody>${a}</tbody>\n        </table>\n      </div>`}).join("");return n+a}(t)}\n          </div>\n        </div>`,document.body.appendChild(o),null==(e=o.querySelector(".grade-info-close"))||e.addEventListener("click",()=>o.remove()),o.addEventListener("click",e=>{e.target===o&&o.remove()})}catch(t){console.error("Failed to open grade info modal:",t)}}()})}(),document.addEventListener("incomeTax:taxRateUpdated",e=>{const t=e&&e.detail?e.detail:{},n=t.rowType,a=Number(t.taxRate)||0;"Current"===n?x.incomeTax.current=a:"Forecast"===n?x.incomeTax.forecast=a:"Average"===n&&(x.incomeTax.average=a),_(),C()}),window.setIncomeTaxRate=function(e,t){const n=(e||"").toLowerCase(),a=Number(t)||0;"current"===n&&(x.incomeTax.current=a),"forecast"===n&&(x.incomeTax.forecast=a),"average"===n&&(x.incomeTax.average=a),_(),C()},document.addEventListener("operatingCost:rateUpdated",e=>{const t=e&&e.detail?e.detail:{},n=t.rowType,a=Number(t.rate)||0;"Current"===n?x.operatingCost.current=a:"Forecast"===n&&(x.operatingCost.forecast=a),_(),C()}),_(),setTimeout(()=>{i&&i.resize(),l&&l.resize()},0)}(o,j),O().then(e=>{try{const t=f(q.records,U.records,e);x=t,s=!1,_(),C()}catch(t){console.error("平均再計算に失敗:",t),s=!1}}).catch(e=>{console.error("全オーナー平均の取得に失敗:",e),s=!1})}catch(M){console.error("Failed to fetch or process kintone data:",M),o.innerHTML="<p>データの取得に失敗しました。</p>"}}(p,o&&o.record):r.spaceId},0),o})}()}();
