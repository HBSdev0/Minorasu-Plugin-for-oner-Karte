/**
 * ============================================================================
 * オーナーカルテ用試算ダッシュボード表示プラグイン
 * ============================================================================
 * 
 * Copyright (c) 2025 ほっとビジネスサポート株式会社
 * All rights reserved.
 * 
 * Website: https://hot-bs.co.jp/
 * 
 * This software is proprietary and confidential.
 * 
 * LICENSE TERMS AND CONDITIONS:
 * 
 * 1. GRANT OF LICENSE
 *    Subject to the terms and conditions of this Agreement, you are granted
 *    a limited, non-exclusive, non-transferable license to use this software
 *    solely for your internal business purposes.
 * 
 * 2. RESTRICTIONS
 *    You may not:
 *    - Reverse engineer, decompile, or disassemble the software
 *    - Modify, adapt, or create derivative works based on the software
 *    - Remove or alter any proprietary notices or labels on the software
 *    - Resell, redistribute, or transfer the software to any third party
 *    - Use the software for any illegal or unauthorized purpose
 *    - Attempt to gain unauthorized access to the software or its systems
 * 
 * 3. OWNERSHIP
 *    This software and all intellectual property rights therein shall
 *    remain the exclusive property of ほっとビジネスサポート株式会社.
 *    You acknowledge that no title to the intellectual property in the
 *    software is transferred to you.
 * 
 * 4. WARRANTY DISCLAIMER
 *    THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
 *    EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 *    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 *    PURPOSE. IN NO EVENT SHALL ほっとビジネスサポート株式会社 BE LIABLE
 *    FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 *    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
 *    OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 *    OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 *    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 *    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
 *    THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 *    SUCH DAMAGE.
 * 
 * 5. TERMINATION
 *    This license is effective until terminated. Your rights under this
 *    license will terminate automatically without notice if you fail to
 *    comply with any of its terms and conditions.
 * 
 * 6. GOVERNING LAW
 *    This Agreement shall be governed by and construed in accordance
 *    with the laws of Japan.
 * 
 * ============================================================================
 * 
 * Third-Party Libraries Used:
 * 
 * Chart.js (v4.4.3) - MIT License
 * Copyright (c) 2013-2023 Chart.js Contributors
 * https://github.com/chartjs/Chart.js
 * 
 * jQuery (v3.7.1) - MIT License
 * Copyright (c) 2010-2023 jQuery Foundation, Inc.
 * https://jquery.com/
 * 
 * ============================================================================
 * 
 * Build Date: 2025-09-17
 * Author: ほっとビジネスサポート株式会社
 * License: Proprietary Commercial License
 * ============================================================================
 */ 
!function(){"use strict";function e(e){const{roa:t,propertyDetails:n}=e,a=document.createElement("div");a.className="tab-content active",a.dataset.tab="roa";const r=n.map((e,t)=>{var n,a,r,o,i,l,c,d,s,u;const p=parseFloat((null==(n=e.market_price)?void 0:n.value)||0),m=parseFloat((null==(a=e.income)?void 0:a.value)||0),v=parseFloat((null==(r=e.inheritance_tax_value)?void 0:r.value)||0),g=v>0?p/v*100:0,y=v>0?m/v*100:0;return`\n        <tr data-prop-index="${t}" data-scenario="current" class="readonly-row">\n            <td rowspan="2">${(null==(o=e.property_name)?void 0:o.value)??""}</td>\n            <td>現状</td>\n            <td><input type="text" id="roaProp_${t}_current_market" value="${(null==(i=e.market_price)?void 0:i.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_income" value="${(null==(l=e.income)?void 0:l.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_inheritance" value="${(null==(c=e.inheritance_tax_value)?void 0:c.value)??0}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_assetEfficiency" value="${String(Math.round(g))}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_current_roa" value="${String(Math.round(y))}" readonly></td>\n        </tr>\n        <tr data-prop-index="${t}" data-scenario="forecast">\n            <td>試算</td>\n            <td><input type="text" id="roaProp_${t}_forecast_market" value="${(null==(d=e.market_price)?void 0:d.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_income" value="${(null==(s=e.income)?void 0:s.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_inheritance" value="${(null==(u=e.inheritance_tax_value)?void 0:u.value)??0}"></td>\n            <td><input type="text" id="roaProp_${t}_forecast_assetEfficiency" value="${String(Math.round(g))}" readonly></td>\n            <td><input type="text" id="roaProp_${t}_forecast_roa" value="${String(Math.round(y))}" readonly></td>\n        </tr>\n    `}).join("");function o(e){const t=null==e?"":String(e);if(""===t)return"";const[n,a]=t.split(".");return(n.startsWith("-")?"-":"")+n.replace("-","").replace(/\B(?=(\d{3})+(?!\d))/g,",")+(void 0!==a?"."+a:"")}function i(e){const t=(e||"").toString().replace(/,/g,""),n=parseFloat(t);return isNaN(n)?0:n}function l(e){const t=(e.value||"").replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,r=o(t);if(a!==r){e.value=r;const t=(a.match(/,/g)||[]).length,o=n+((r.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(o,r.length)),Math.max(0,Math.min(o,r.length)))}}}function c(){const e=n.length;let t=0,a=0,r=0,l=0,c=0,d=0;for(let n=0;n<e;n++){t+=i(document.getElementById(`roaProp_${n}_current_market`).value),a+=i(document.getElementById(`roaProp_${n}_current_income`).value),r+=i(document.getElementById(`roaProp_${n}_current_inheritance`).value);l+=i(document.getElementById(`roaProp_${n}_forecast_market`).value),c+=i(document.getElementById(`roaProp_${n}_forecast_income`).value),d+=i(document.getElementById(`roaProp_${n}_forecast_inheritance`).value)}document.getElementById("roaTblCurrentMarketPrice").value=o(t),document.getElementById("roaTblCurrentIncome").value=o(a),document.getElementById("roaTblCurrentInheritance").value=o(r),document.getElementById("roaTblForecastMarketPrice").value=o(l),document.getElementById("roaTblForecastIncome").value=o(c),document.getElementById("roaTblForecastInheritance").value=o(d);const s=r>0?t/r*100:0,u=d>0?l/d*100:0,p=r>0?a/r*100:0,m=d>0?c/d*100:0;document.getElementById("roaTblCurrentAssetEfficiency").value=String(Math.round(s)),document.getElementById("roaTblCurrentRoa").value=String(Math.round(p)),document.getElementById("roaTblForecastAssetEfficiency").value=String(Math.round(u)),document.getElementById("roaTblForecastRoa").value=String(Math.round(m));const v=document.getElementById("roaCurrent"),g=document.getElementById("roaForecast");v&&(v.value=String(p),v.dispatchEvent(new Event("input",{bubbles:!0}))),g&&(g.value=String(m),g.dispatchEvent(new Event("input",{bubbles:!0})));const y=document.getElementById("assetEfficiencyCurrent"),h=document.getElementById("assetEfficiencyForecast");y&&(y.value=String(s),y.dispatchEvent(new Event("input",{bubbles:!0}))),h&&(h.value=String(u),h.dispatchEvent(new Event("input",{bubbles:!0})))}function d(){c()}function s(){c()}function u(e,t){const n=document.getElementById(`roaProp_${e}_${t}_market`),a=document.getElementById(`roaProp_${e}_${t}_income`),r=document.getElementById(`roaProp_${e}_${t}_inheritance`),o=document.getElementById(`roaProp_${e}_${t}_assetEfficiency`),l=document.getElementById(`roaProp_${e}_${t}_roa`);if(!(n&&a&&r&&o&&l))return;const d=i(n.value),s=i(a.value),u=i(r.value),p=u>0?d/u*100:0,m=u>0?s/u*100:0;o.value=String(Math.round(p)),l.value=String(Math.round(m)),c()}a.innerHTML=`\n        <div class="form-container">\n            <table class="roa-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>実勢価格</th>\n                        <th>収支</th>\n                        <th>相続税評価額</th>\n                        <th>資産効率(%)</th>\n                        <th>ROA(%)</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="roaTblCurrentMarketPrice" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentIncome" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentInheritance" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentAssetEfficiency" value="0" readonly></td>\n                        <td><input type="text" id="roaTblCurrentRoa" value="0" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="roaTblForecastMarketPrice" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastIncome" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastInheritance" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastAssetEfficiency" value="0" readonly></td>\n                        <td><input type="text" id="roaTblForecastRoa" value="0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n\n            <table class="roa-pivot-table">\n                <thead>\n                    <tr>\n                        <th>物件名</th>\n                        <th>現状/試算</th>\n                        <th>実勢価格</th>\n                        <th>収支</th>\n                        <th>相続税評価額</th>\n                        <th>資産効率(%)</th>\n                        <th>ROA(%)</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${r}\n                </tbody>\n            </table>\n\n            <div class="calculation-formula-container">\n                <div class="formula-content">\n                    <p>資産効率 = 実勢価格 ÷ 相続税評価額 × 100</p>\n                    <p>ROA = 収支 ÷ 相続税評価額 × 100</p>\n                </div>\n            </div>\n\n            \x3c!-- トップ表/チャート連携用（非表示） --\x3e\n            \x3c!-- ROA（%） --\x3e\n            <input type="number" id="roaCurrent" value="${t.current}" min="0" max="999" step="0.1" style="display:none;">\n            <input type="number" id="roaForecast" value="${t.forecast}" min="0" max="999" step="0.1" style="display:none;">\n            \x3c!-- 資産効率（%） --\x3e\n            <input type="number" id="assetEfficiencyCurrent" value="0" min="0" max="999" step="0.1" style="display:none;">\n            <input type="number" id="assetEfficiencyForecast" value="0" min="0" max="999" step="0.1" style="display:none;">\n        </div>\n    `;const p=document.getElementById("roaTblCurrentRoa");p&&(p.value=String(Math.round(Number(t.current||0))));const m=document.getElementById("roaTblForecastRoa");return m&&(m.value=String(Math.round(Number(t.forecast||0)))),["roaTblForecastMarketPrice","roaTblForecastIncome","roaTblForecastInheritance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{l(e.target),d()}),t.addEventListener("blur",e=>{l(e.target)}))}),["roaTblCurrentMarketPrice","roaTblCurrentIncome","roaTblCurrentInheritance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{l(e.target),s()}),t.addEventListener("blur",e=>{l(e.target)}))}),setTimeout(()=>{["roaTblCurrentMarketPrice","roaTblCurrentIncome","roaTblCurrentInheritance","roaTblForecastMarketPrice","roaTblForecastIncome","roaTblForecastInheritance"].forEach(e=>{const t=document.getElementById(e);t&&l(t)}),s(),d();const e=n.length;for(let t=0;t<e;t++)["current","forecast"].forEach(e=>{["market","income","inheritance"].forEach(n=>{const a=document.getElementById(`roaProp_${t}_${e}_${n}`);a&&l(a)}),u(t,e)});!function(){const e=n.length;for(let t=0;t<e;t++)["market","income","inheritance"].forEach(e=>{const n=document.getElementById(`roaProp_${t}_forecast_${e}`);n&&(n.addEventListener("input",e=>{l(e.target),u(t,"forecast")}),n.addEventListener("blur",e=>{l(e.target)}))})}()},0),a}function t(e){const{operatingCost:t,propertyDetails:n}=e,a=document.createElement("div");a.className="tab-content",a.dataset.tab="operatingCost";const r=n.map((e,t)=>{var n,a,r,o,i,l,c,d,s,u,p,m,v,g,y;return`\n        <tr data-prop-index="${t}" data-scenario="current" class="readonly-row">\n            <td rowspan="2">${(null==(n=e.property_name)?void 0:n.value)??""}</td>\n            <td>現状</td>\n            <td><input type="text" id="operatingCostProp_${t}_current_rate" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_noiRate" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_propertyTax" value="${(null==(a=e.property_tax)?void 0:a.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_management" value="${(null==(r=e.management_fee)?void 0:r.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_repair" value="${(null==(o=e.building_repair_cost)?void 0:o.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_restoration" value="${(null==(i=e.restoration_cost)?void 0:i.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_maintenance" value="${(null==(l=e.maintenance_cost)?void 0:l.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_netIncome" value="${(null==(c=e.net_income)?void 0:c.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_fullRent" value="${(null==(d=e.full_rent)?void 0:d.value)??0}" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_totalCost" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_current_noi" value="0" readonly></td>\n        </tr>\n        <tr data-prop-index="${t}" data-scenario="forecast">\n            <td>試算</td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_rate" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_noiRate" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_propertyTax" value="${(null==(s=e.property_tax)?void 0:s.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_management" value="${(null==(u=e.management_fee)?void 0:u.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_repair" value="${(null==(p=e.building_repair_cost)?void 0:p.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_restoration" value="${(null==(m=e.restoration_cost)?void 0:m.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_maintenance" value="${(null==(v=e.maintenance_cost)?void 0:v.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_netIncome" value="${(null==(g=e.net_income)?void 0:g.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_fullRent" value="${(null==(y=e.full_rent)?void 0:y.value)??0}"></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_totalCost" value="0" readonly></td>\n            <td><input type="text" id="operatingCostProp_${t}_forecast_noi" value="0" readonly></td>\n        </tr>\n    `}).join("");function o(e){const t=null==e?"":String(e);if(""===t)return"";const[n,a]=t.split(".");return(n.startsWith("-")?"-":"")+n.replace("-","").replace(/\B(?=(\d{3})+(?!\d))/g,",")+(void 0!==a?"."+a:"")}function i(e){const t=(e||"").toString().replace(/,/g,""),n=parseFloat(t);return isNaN(n)?0:n}function l(e){const t=(e.value||"").replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,r=o(t);if(a!==r){e.value=r;const t=(a.match(/,/g)||[]).length,o=n+((r.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(o,r.length)),Math.max(0,Math.min(o,r.length)))}}}function c(){const e=n.length;let t=0,a=0,r=0,l=0,c=0,d=0,s=0,u=0,p=0,m=0,v=0,g=0,y=0,h=0;for(let n=0;n<e;n++)t+=i(document.getElementById(`operatingCostProp_${n}_current_propertyTax`).value),a+=i(document.getElementById(`operatingCostProp_${n}_current_management`).value),r+=i(document.getElementById(`operatingCostProp_${n}_current_repair`).value),l+=i(document.getElementById(`operatingCostProp_${n}_current_restoration`).value),c+=i(document.getElementById(`operatingCostProp_${n}_current_maintenance`).value),d+=i(document.getElementById(`operatingCostProp_${n}_current_netIncome`).value),s+=i(document.getElementById(`operatingCostProp_${n}_current_fullRent`).value),u+=i(document.getElementById(`operatingCostProp_${n}_forecast_propertyTax`).value),p+=i(document.getElementById(`operatingCostProp_${n}_forecast_management`).value),m+=i(document.getElementById(`operatingCostProp_${n}_forecast_repair`).value),v+=i(document.getElementById(`operatingCostProp_${n}_forecast_restoration`).value),g+=i(document.getElementById(`operatingCostProp_${n}_forecast_maintenance`).value),y+=i(document.getElementById(`operatingCostProp_${n}_forecast_netIncome`).value),h+=i(document.getElementById(`operatingCostProp_${n}_forecast_fullRent`).value);document.getElementById("operatingCostTblCurrentPropertyTax").value=o(t),document.getElementById("operatingCostTblCurrentManagement").value=o(a),document.getElementById("operatingCostTblCurrentRepair").value=o(r),document.getElementById("operatingCostTblCurrentRestoration").value=o(l),document.getElementById("operatingCostTblCurrentMaintenance").value=o(c),document.getElementById("operatingCostTblCurrentNetIncome").value=o(d),document.getElementById("operatingCostTblCurrentFullRent").value=o(s),document.getElementById("operatingCostTblForecastPropertyTax").value=o(u),document.getElementById("operatingCostTblForecastManagement").value=o(p),document.getElementById("operatingCostTblForecastRepair").value=o(m),document.getElementById("operatingCostTblForecastRestoration").value=o(v),document.getElementById("operatingCostTblForecastMaintenance").value=o(g),document.getElementById("operatingCostTblForecastNetIncome").value=o(y),document.getElementById("operatingCostTblForecastFullRent").value=o(h);const f=t+a+r+l+c,x=u+p+m+v+g;document.getElementById("operatingCostTblCurrentTotalCost").value=o(f),document.getElementById("operatingCostTblForecastTotalCost").value=o(x);const b=s>0?f/s*100:0,_=h>0?x/h*100:0;document.getElementById("operatingCostTblCurrentRate").value=String(Math.round(b)),document.getElementById("operatingCostTblForecastRate").value=String(Math.round(_));const T=d-f,C=y-x;document.getElementById("operatingCostTblCurrentNoi").value=o(T),document.getElementById("operatingCostTblForecastNoi").value=o(C);const I=s>0?T/s*100:0,E=h>0?C/h*100:0;document.getElementById("operatingCostTblCurrentNoiRate").value=String(Math.round(I)),document.getElementById("operatingCostTblForecastNoiRate").value=String(Math.round(E));const $=document.getElementById("operatingCostCurrent"),F=document.getElementById("operatingCostForecast");$&&($.value=String(b),$.dispatchEvent(new Event("input",{bubbles:!0}))),F&&(F.value=String(_),F.dispatchEvent(new Event("input",{bubbles:!0})));const B=document.getElementById("noiCurrent"),w=document.getElementById("noiForecast");B&&(B.value=String(I),B.dispatchEvent(new Event("input",{bubbles:!0}))),w&&(w.value=String(E),w.dispatchEvent(new Event("input",{bubbles:!0})))}function d(e,t){const n=document.getElementById(`operatingCostProp_${e}_${t}_propertyTax`),a=document.getElementById(`operatingCostProp_${e}_${t}_management`),r=document.getElementById(`operatingCostProp_${e}_${t}_repair`),l=document.getElementById(`operatingCostProp_${e}_${t}_restoration`),d=document.getElementById(`operatingCostProp_${e}_${t}_maintenance`),s=document.getElementById(`operatingCostProp_${e}_${t}_netIncome`),u=document.getElementById(`operatingCostProp_${e}_${t}_fullRent`),p=document.getElementById(`operatingCostProp_${e}_${t}_totalCost`),m=document.getElementById(`operatingCostProp_${e}_${t}_noi`),v=document.getElementById(`operatingCostProp_${e}_${t}_rate`),g=document.getElementById(`operatingCostProp_${e}_${t}_noiRate`);if(!(n&&a&&r&&l&&d&&s&&u&&p&&m&&v&&g))return;const y=i(n.value),h=i(a.value),f=i(r.value),x=i(l.value),b=i(d.value),_=i(s.value),T=i(u.value),C=y+h+f+x+b,I=T>0?C/T*100:0,E=_-C,$=T>0?E/T*100:0;p.value=o(C),v.value=String(Math.round(I)),m.value=o(E),g.value=String(Math.round($)),c()}a.innerHTML=`\n        <div class="form-container">\n            <table class="operating-cost-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>運営コスト率(%)</th>\n                        <th>NOI率(%)</th>\n                        <th>固都税</th>\n                        <th>管理料</th>\n                        <th>建物修繕費</th>\n                        <th>原状回復費</th>\n                        <th>メンテ経費</th>\n                        <th>実質収入</th>\n                        <th>満室賃料</th>\n                        <th>運営コスト合計</th>\n                        <th>NOI</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="operatingCostTblCurrentRate" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNoiRate" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentPropertyTax" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentManagement" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentRepair" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentRestoration" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentMaintenance" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNetIncome" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentFullRent" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentTotalCost" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblCurrentNoi" value="0" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="operatingCostTblForecastRate" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNoiRate" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastPropertyTax" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastManagement" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastRepair" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastRestoration" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastMaintenance" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNetIncome" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastFullRent" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastTotalCost" value="0" readonly></td>\n                        <td><input type="text" id="operatingCostTblForecastNoi" value="0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n\n            <table class="operating-cost-pivot-table">\n                <thead>\n                    <tr>\n                        <th>物件名</th>\n                        <th>現状/試算</th>\n                        <th>運営コスト率(%)</th>\n                        <th>NOI率(%)</th>\n                        <th>固都税</th>\n                        <th>管理料</th>\n                        <th>建物修繕費</th>\n                        <th>原状回復費</th>\n                        <th>メンテ経費</th>\n                        <th>実質収入</th>\n                        <th>満室賃料</th>\n                        <th>運営コスト合計</th>\n                        <th>NOI</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${r}\n                </tbody>\n            </table>\n\n            <div class="calculation-formula-container">\n                <div class="formula-content">\n                    <p>運営コスト合計 = 固都税 + 管理料 + 建物修繕費 + 原状回復費 + メンテ経費</p>\n                    <p>運営コスト率 = 運営コスト合計 ÷ 満室賃料 × 100</p>\n                    <p>NOI = 実質収入 - 運営コスト合計</p>\n                    <p>NOI率 = NOI ÷ 満室賃料 × 100</p>\n            </div>\n            </div>\n\n            \x3c!-- トップ表/チャート連携用（非表示） --\x3e\n            <input type="number" id="operatingCostCurrent" value="${t.current}" min="0" max="100" step="0.1" style="display:none;">\n            <input type="number" id="operatingCostForecast" value="${t.forecast}" min="0" max="100" step="0.1" style="display:none;">\n            \x3c!-- NOI率 連動用（非表示） --\x3e\n            <input type="number" id="noiCurrent" value="0" min="0" max="100" step="0.1" style="display:none;">\n            <input type="number" id="noiForecast" value="0" min="0" max="100" step="0.1" style="display:none;">\n        </div>\n    `;const s=document.getElementById("operatingCostTblCurrentRate");s&&(s.value=String(Math.round(Number(t.current||0))));const u=document.getElementById("operatingCostTblForecastRate");return u&&(u.value=String(Math.round(Number(t.forecast||0)))),setTimeout(()=>{c();const e=n.length;for(let t=0;t<e;t++)["current","forecast"].forEach(e=>{["propertyTax","management","repair","restoration","maintenance","netIncome","fullRent"].forEach(n=>{const a=document.getElementById(`operatingCostProp_${t}_${e}_${n}`);a&&l(a)}),d(t,e)});!function(){const e=n.length;for(let t=0;t<e;t++)["propertyTax","management","repair","restoration","maintenance","netIncome","fullRent"].forEach(e=>{const n=document.getElementById(`operatingCostProp_${t}_forecast_${e}`);n&&(n.addEventListener("input",e=>{l(e.target),d(t,"forecast")}),n.addEventListener("blur",e=>{l(e.target)}))})}()},0),a}let n=a({assetEfficiency:[{score:5,min:120,max:1/0},{score:4,min:100,max:120},{score:3,min:80,max:100},{score:2,min:60,max:80},{score:1,min:-1/0,max:60}],roa:[{score:5,min:8,max:1/0},{score:4,min:6,max:8},{score:3,min:4,max:6},{score:2,min:2,max:4},{score:1,min:-1/0,max:2}],incomeTax:[{score:5,min:-1/0,max:10},{score:4,min:10,max:20},{score:3,min:20,max:30},{score:2,min:30,max:40},{score:1,min:40,max:1/0}],operatingCost:[{score:5,min:-1/0,max:15},{score:4,min:15,max:20},{score:3,min:20,max:25},{score:2,min:25,max:30},{score:1,min:30,max:1/0}],noi:[{score:5,min:8,max:1/0},{score:4,min:6,max:8},{score:3,min:4,max:6},{score:2,min:2,max:4},{score:1,min:-1/0,max:2}]});function a(e){if(Array.isArray(e))return e.map(e=>a(e));if(e&&"object"==typeof e){const t={};for(const n of Object.keys(e))t[n]=a(e[n]);return t}return e}!function(){const r=kintone.$PLUGIN_ID;let o=kintone.plugin.app.getConfig(r);if("string"==typeof o)try{o=JSON.parse(o)}catch(B){o={}}if(!(o&&o.spaceId&&o.ownerAppId&&o.propertyAppId))return;let i=null,l=null,c=!1,d=!0,s=!1;function u(){!function(e){try{if(e&&e.gradeSettings){const t="string"==typeof e.gradeSettings?JSON.parse(e.gradeSettings):e.gradeSettings;Object.keys(t||{}).forEach(e=>{const a=t[e];if(!a||!Array.isArray(a.levels))return;const r="lower"===a.orientation||"higher"===a.orientation?a.orientation:"higher",o="boolean"!=typeof a.includeLower||a.includeLower,i="boolean"==typeof a.includeUpper&&a.includeUpper;function l(e,t){if(""===e||null==e)return t?-1/0:1/0;if("number"==typeof e)return isFinite(e)?e:t?-1/0:1/0;const n=String(e).trim();if(""===n)return t?-1/0:1/0;if("infinity"===n.toLowerCase()||"+Infinity"===n)return 1/0;if("-infinity"===n.toLowerCase())return-1/0;const a=Number(n);return isNaN(a)?t?-1/0:1/0:a}let c=a.levels.map(e=>{const t=l(e.min,!0),n=l(e.max,!1),a="gte"===e.minType||"gt"===e.minType?e.minType:null,r="lte"===e.maxType||"lt"===e.maxType?e.maxType:null,c=a?"gte"===a:o,d=r?"lte"===r:i;return{min:t,max:n,grade:e.grade,includeLower:c,includeUpper:d}}).filter(e=>void 0!==e.min&&void 0!==e.max);const d=c.length,s=c.map((e,t)=>{const n=parseInt(e.grade,10),a=Number.isFinite(n)&&n>0?n:null;return{score:null!=a?a:"higher"===r?t+1:d-t,min:e.min,max:e.max,includeLower:e.includeLower,includeUpper:e.includeUpper}});n[e]=s})}else if(e&&e.gradeThresholds){const t="string"==typeof e.gradeThresholds?JSON.parse(e.gradeThresholds):e.gradeThresholds;Object.keys(t||{}).forEach(e=>{if(!t[e])return;const a=[5,4,3,2,1],r=["grade5","grade4","grade3","grade2","grade1"].map((n,r)=>{var o,i;let l=parseFloat(null==(o=t[e][n])?void 0:o.min),c=parseFloat(null==(i=t[e][n])?void 0:i.max);return isNaN(l)&&(l=-1/0),isNaN(c)&&(c=1/0),{score:a[r],min:l,max:c,includeLower:!0,includeUpper:!1}});n[e]=r})}}catch(t){}}(o)}function p(){return function(){try{const e=Object.keys(n).map(e=>(Array.isArray(n[e])?n[e]:[]).reduce((e,t)=>Math.max(e,Number.isFinite(t.score)?t.score:0),0)),t=Math.max(5,...e);return isFinite(t)&&t>0?t:5}catch(B){return 5}}()}const m=["assetEfficiency","roa","incomeTax","operatingCost","noi"],v=["current","average","forecast"],g=["資産効率(%)","ROA(%)","所得税率(%)","運営コスト率(%)","NOI率(%)"];function y(e,t){const n=function(e){try{const t=/^#?([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})$/.exec(String(e||"").trim());return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}catch(B){return null}}(e);if(n)return`rgba(${n.r}, ${n.g}, ${n.b}, ${t})`;const a=function(e){try{const t=/^rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/.exec(String(e||"").trim());return t?{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}:null}catch(B){return null}}(e);return a?`rgba(${a.r}, ${a.g}, ${a.b}, ${t})`:e}const h=function(){let e="#007BFF",t="#FF5722",n="#4CAF50";return(null==o?void 0:o.colorCurrent)&&(e=String(o.colorCurrent)),(null==o?void 0:o.colorAverage)&&(t=String(o.colorAverage)),(null==o?void 0:o.colorForecast)&&(n=String(o.colorForecast)),[{label:"現状",color:e},{label:"平均",color:t},{label:"試算",color:n}].map(e=>({label:e.label,border:y(e.color,1),bgRadar:y(e.color,.2),bgBar:y(e.color,.8),bwRadar:2,bwBar:1}))}();let f={};async function x(e,t="",n=500){const a=[];let r=null,o=!0,i=0,l=0;function c(e,t,n){const a=[],r=String(e||"").trim();return r&&a.push(`(${r})`),t&&a.push(`$id > ${t}`),a.push(`order by $id asc limit ${n}`),a.join(" ")}for(;o;)try{const d={app:e,query:c(t,r,n),fields:[],totalCount:!0},s=await kintone.api("/k/v1/records.json","GET",d);s.records&&s.records.length>0?(a.push(...s.records),r=s.records[s.records.length-1].$id.value,i+=s.records.length,i%1e3==0||s.records.length,s.records.length<n&&(o=!1),l=0):o=!1}catch(d){if(console.error(`BI Dashboard Plugin: アプリ${e}のレコード取得エラー (試行${l+1}/3):`,d),l++,l>=3)console.error(`BI Dashboard Plugin: アプリ${e}のレコード取得を最大リトライ回数に達したため終了`),o=!1;else{const e=1e3*Math.pow(2,l);await new Promise(t=>setTimeout(t,e))}}return a.length,{records:a}}function b(e,t,n,a){var r,i,l,c,d,s,u,p,m,v,g;function y(e,t){return e&&"object"==typeof e&&null!==e&&"value"in e?e:{value:t}}function h(e){return e?{annual_rent:y(null==e?void 0:e[o.ownerAnnRent],0),annual_management_fee:y(null==e?void 0:e[o.ownerAnnMgmtFee],0),land_property_tax:y(null==e?void 0:e[o.ownerLandPropTax],0),building_property_tax:y(null==e?void 0:e[o.ownerBldgPropTax],0),long_term_repair_cost:y(null==e?void 0:e[o.ownerLongTermRepair],0),maintenance_cost:y(null==e?void 0:e[o.ownerMaint],0),loan_interest:y(null==e?void 0:e[o.ownerLoanInterest],0),depreciation:y(null==e?void 0:e[o.ownerDepreciation],0),annual_insurance_premium:y(null==e?void 0:e[o.ownerAnnInsurance],0),inheritance_tax_rate:y(void 0,0),borrowing_rate:y(void 0,0)}:null}const f=Array.isArray(e)?e.map(function(e){return{property_name:y(null==e?void 0:e[o.propertyName],""),market_price:y(null==e?void 0:e[o.propMarketPrice],0),income:y(null==e?void 0:e[o.propIncome],0),inheritance_tax_value:y(null==e?void 0:e[o.propInheritanceTaxVal],0),property_tax:y(null==e?void 0:e[o.propPropTax],0),management_fee:y(null==e?void 0:e[o.propMgmtFee],0),building_repair_cost:y(null==e?void 0:e[o.propBldgRepair],0),restoration_cost:y(null==e?void 0:e[o.propRestoration],0),maintenance_cost:y(null==e?void 0:e[o.propMaint],0),net_income:y(null==e?void 0:e[o.propNetIncome],0),full_rent:y(null==e?void 0:e[o.propFullRent],0)}}):[],x=Array.isArray(t)&&t.length>0?h(t[0]):null;try{f[0]}catch(B){}let b=0,_=0,T=0,C=0,I=0,E=0;f.forEach(e=>{var t,n,a,r,o,i,l,c,d,s,u,p;b+=parseFloat((null==(t=e.market_price)?void 0:t.value)||0),_+=parseFloat((null==(n=e.income)?void 0:n.value)||0),C+=parseFloat((null==(a=e.inheritance_tax_value)?void 0:a.value)||0);const m=parseFloat((null==(r=e.property_tax)?void 0:r.value)||0)+parseFloat((null==(o=e.management_fee)?void 0:o.value)||0)+parseFloat((null==(i=e.building_repair_cost)?void 0:i.value)||0)+parseFloat((null==(l=e.restoration_cost)?void 0:l.value)||0)+parseFloat((null==(c=e.maintenance_cost)?void 0:c.value)||0);I+=m;const v=parseFloat((null==(d=e.full_rent)?void 0:d.value)||0);E+=v;const g=parseFloat((null==(s=e.net_income)?void 0:s.value)||0);T+=g,parseFloat((null==(u=e.income)?void 0:u.value)||0),parseFloat((null==(p=e.inheritance_tax_value)?void 0:p.value)||0)});let $=function(e){const{owners:t,properties:n}=e,a={};n.forEach(e=>{var t;const n=null==(t=e[o.propertyOwnerId])?void 0:t.value;n&&(a[n]||(a[n]=[]),a[n].push(e))});const r=[];t.forEach(e=>{var t,n,i,l,c,d,s,u,p,m,v,g;const y=null==(t=e[o.ownerId])?void 0:t.value;if(!y)return;const f=a[y]||[];if(0===f.length)return;let x=0,b=0,_=0,T=0,C=0;f.forEach(e=>{var t,n,a,r,i,l,c,d,s;const u=parseFloat((null==(t=e[o.propIncome])?void 0:t.value)||0),p=parseFloat((null==(n=e[o.propInheritanceTaxVal])?void 0:n.value)||0),m=parseFloat((null==(a=e[o.propFullRent])?void 0:a.value)||0),v=parseFloat((null==(r=e[o.propNetIncome])?void 0:r.value)||0),g=parseFloat((null==(i=e[o.propPropTax])?void 0:i.value)||0)+parseFloat((null==(l=e[o.propMgmtFee])?void 0:l.value)||0)+parseFloat((null==(c=e[o.propBldgRepair])?void 0:c.value)||0)+parseFloat((null==(d=e[o.propRestoration])?void 0:d.value)||0)+parseFloat((null==(s=e[o.propMaint])?void 0:s.value)||0);x+=u,b+=v,_+=p,T+=g,C+=m});const I=_>0?x/_*100:0,E=C>0?T/C*100:0;let $=0;f.forEach(e=>{var t;const n=parseFloat((null==(t=e[o.propMarketPrice])?void 0:t.value)||0);$+=n});const F=_>0?$/_*100:0,B=C>0?(b-T)/C*100:0,w=h(e);let M=0;if(w){const e=parseFloat((null==(n=w.annual_management_fee)?void 0:n.value)||0)+parseFloat((null==(i=w.land_property_tax)?void 0:i.value)||0)+parseFloat((null==(l=w.building_property_tax)?void 0:l.value)||0)+parseFloat((null==(c=w.long_term_repair_cost)?void 0:c.value)||0)+parseFloat((null==(d=w.maintenance_cost)?void 0:d.value)||0)+parseFloat((null==(s=w.loan_interest)?void 0:s.value)||0)+parseFloat((null==(u=w.depreciation)?void 0:u.value)||0)+parseFloat((null==(p=w.annual_insurance_premium)?void 0:p.value)||0);M=parseFloat((null==(m=w.annual_rent)?void 0:m.value)||0)-e}let R=0;M>4e7?R=45:M>18e6?R=40:M>9e6?R=33:M>695e4?R=23:M>33e5?R=20:M>195e4?R=10:M>0&&(R=5);const S=h(e),P=parseFloat((null==(v=null==S?void 0:S.inheritance_tax_rate)?void 0:v.value)||0),k=parseFloat((null==(g=null==S?void 0:S.borrowing_rate)?void 0:g.value)||0);r.push({assetEfficiency:F,roa:I,operatingCostRate:E,incomeTaxRate:R,inheritanceTaxRate:P,borrowingRate:k,noiRate:B})});const i={assetEfficiency:0,roa:0,operatingCost:0,incomeTax:0,inheritanceTax:0,borrowing:0,noi:0};if(r.length>0){const e=r.reduce((e,t)=>(e.assetEfficiency+=t.assetEfficiency,e.roa+=t.roa,e.operatingCost+=t.operatingCostRate,e.incomeTax+=t.incomeTaxRate,e.inheritanceTax+=t.inheritanceTaxRate,e.borrowing+=t.borrowingRate,e.noi+=t.noiRate,e),{assetEfficiency:0,roa:0,operatingCost:0,incomeTax:0,inheritanceTax:0,borrowing:0,noi:0}),t=r.length;i.assetEfficiency=e.assetEfficiency/t,i.roa=e.roa/t,i.operatingCost=e.operatingCost/t,i.incomeTax=e.incomeTax/t,i.inheritanceTax=e.inheritanceTax/t,i.borrowing=e.borrowing/t,i.noi=e.noi/t}return i}(n||{owners:[],properties:[]});try{if("savedField"===(o&&"string"==typeof o.averageMode?o.averageMode:"compute")){const e=a||{},t=t=>{if(!t)return 0;const n=e[t];return n&&"object"==typeof n&&null!==n&&"value"in n?parseFloat(n.value)||0:parseFloat(e[t])||0},n=t(null==o?void 0:o.avgAssetEfficiencyField),r=t(null==o?void 0:o.avgRoaField),i=t(null==o?void 0:o.avgIncomeTaxField),l=t(null==o?void 0:o.avgOperatingCostField);$={assetEfficiency:n,roa:r,operatingCost:l,incomeTax:i,inheritanceTax:0,borrowing:0,noi:t(null==o?void 0:o.avgNoiField)}}}catch(N){console.warn("平均の取得方法切替で例外が発生しました。computeにフォールバックします。",N)}const F=C>0?_/C*100:0,w=E>0?I/E*100:0,M=C>0?b/C*100:0,R=E>0?(T-I)/E*100:0;let S=0,P=0,k=0;if(x){const e=parseFloat((null==(r=x.annual_management_fee)?void 0:r.value)||0)+parseFloat((null==(i=x.land_property_tax)?void 0:i.value)||0)+parseFloat((null==(l=x.building_property_tax)?void 0:l.value)||0)+parseFloat((null==(c=x.long_term_repair_cost)?void 0:c.value)||0)+parseFloat((null==(d=x.maintenance_cost)?void 0:d.value)||0)+parseFloat((null==(s=x.loan_interest)?void 0:s.value)||0)+parseFloat((null==(u=x.depreciation)?void 0:u.value)||0)+parseFloat((null==(p=x.annual_insurance_premium)?void 0:p.value)||0);S=parseFloat((null==(m=x.annual_rent)?void 0:m.value)||0)-e,P=parseFloat((null==(v=x.inheritance_tax_rate)?void 0:v.value)||0),k=parseFloat((null==(g=x.borrowing_rate)?void 0:g.value)||0)}let L=0;return S>4e7?L=45:S>18e6?L=40:S>9e6?L=33:S>695e4?L=23:S>33e5?L=20:S>195e4?L=10:S>0&&(L=5),{assetEfficiency:{current:M,average:$.assetEfficiency,forecast:M},roa:{current:F,average:$.roa,forecast:F},incomeTax:{current:L,average:$.incomeTax,forecast:L},inheritanceTax:{current:P,average:$.inheritanceTax,forecast:P},borrowing:{current:k,average:$.borrowing,forecast:k},operatingCost:{current:w,average:$.operatingCost,forecast:w},noi:{current:R,average:$.noi,forecast:R},propertyDetails:f,ownerDetails:x,calculatedIncomeTaxable:S,calculatedIncomeTaxRate:L}}function _(e){return e.charAt(0).toUpperCase()+e.slice(1)}function T(){document.querySelectorAll("#dataTable tbody tr").forEach((e,t)=>{const n=m[t];if(!n||!f[n])return;const a=f[n],r=e.querySelectorAll("td");r.length<4||(r[1].textContent=String(Math.round(a.current)),r[2].textContent=s?"集計中":String(Math.round(a.average)),r[3].textContent=String(Math.round(a.forecast)))})}function C(e,t=f){try{if(d){const a=m.map(a=>{if(!t[a])return console.warn(`Missing data for metric: ${a}`),1;const r=t[a][e];return null==r?(console.warn(`Missing value for ${a}.${e}:`,r),1):function(e,t){const a=n[e];if(!a)return 1;const r=parseFloat(t);if(isNaN(r))return 1;for(const n of a){const e="boolean"!=typeof n.includeLower||n.includeLower,t="boolean"==typeof n.includeUpper&&n.includeUpper,a=e?r>=n.min:r>n.min,o=t?r<=n.max:r<n.max;if(a&&o)return Number(n.score)||1}return 1}(a,r)});return a}return c?m.map(n=>{if(!t[n])return console.warn(`Missing data for metric: ${n}`),0;const a=parseFloat(t[n].average)||0,r=parseFloat(t[n].current)||0,o=parseFloat(t[n].forecast)||0;return"current"===e?a>0?r/a:0:"forecast"===e?a>0?o/a:0:1}):m.map(n=>t[n]&&null!==t[n][e]&&void 0!==t[n][e]?parseFloat(t[n][e])||0:(console.warn(`Missing value for ${n}.${e}`),0))}catch(a){return console.error("Error in getChartValues:",a),m.map(()=>d?1:0)}}function I(){try{F(),v.forEach((e,t)=>{const n=C(e);if(n&&Array.isArray(n)&&n.length===m.length){const a=n.map(e=>Number(e)||0),r=!("average"!==e||!s);i&&i.data&&i.data.datasets&&i.data.datasets[t]&&(i.data.datasets[t].data=a,i.data.datasets[t].hidden=r),l&&l.data&&l.data.datasets&&l.data.datasets[t]&&(l.data.datasets[t].data=a,l.data.datasets[t].hidden=r)}else console.warn(`Invalid chart values for field ${e}:`,n)}),i&&i.update&&i.update(),l&&l.update&&l.update()}catch(e){console.error("Error updating charts:",e)}}function E(e,t){if(""===e||null==e)return t?-1/0:1/0;const n=Number(e);return isNaN(n)?t?-1/0:1/0:n}function $(e){return e===1/0?"∞":e===-1/0?"-∞":"number"!=typeof e?String(e??""):Number.isInteger(e)?String(e):e.toFixed(2)}function F(){try{if(d){const e=p();i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=e,i.options.scales.r.min=0,i.options.scales.r.beginAtZero=!0,i.options.scales.r.ticks||(i.options.scales.r.ticks={}),i.options.scales.r.ticks.suggestedMin=0,i.options.scales.r.ticks.stepSize=1),l&&l.options&&l.options.scales&&l.options.scales.y&&(l.options.scales.y.max=e,l.options.scales.y.min=0,l.options.scales.y.beginAtZero=!0,l.options.scales.y.ticks||(l.options.scales.y.ticks={}),l.options.scales.y.ticks.suggestedMin=0,l.options.scales.y.ticks.stepSize=1)}else if(c){const e=Math.max(...m.map(e=>{const t=f[e].current,n=f[e].forecast,a=f[e].average,r=a>0?t/a:0,o=a>0?n/a:0;return Math.max(r,o,1)})),t=Math.min(...m.map(e=>{const t=f[e].current,n=f[e].forecast,a=f[e].average,r=a>0?t/a:0,o=a>0?n/a:0;return Math.min(r,o,1)})),n=Math.max(e-1,1-t),a=Math.max(.2*n,.2),r=1+n+a,o=Math.max(1-n-a,0);i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=r,i.options.scales.r.min=o,i.options.scales.r.beginAtZero=!1),l&&l.options&&l.options.scales&&l.options.scales.y&&(l.options.scales.y.max=r,l.options.scales.y.min=o,l.options.scales.y.beginAtZero=!1)}else if(i&&i.options&&i.options.scales&&i.options.scales.r&&(i.options.scales.r.max=100,i.options.scales.r.min=0,i.options.scales.r.beginAtZero=!0),l&&l.options&&l.options.scales&&l.options.scales.y){const e=Math.max(...m.map(e=>{const t=parseFloat(f[e].current)||0,n=parseFloat(f[e].forecast)||0,a=parseFloat(f[e].average)||0;return Math.max(t,n,a)})),t=Math.min(...m.map(e=>{const t=parseFloat(f[e].current)||0,n=parseFloat(f[e].forecast)||0,a=parseFloat(f[e].average)||0;return Math.min(t,n,a)})),n=Math.max(.1*(e-t),5),a=e+n,r=Math.max(t-n,0);l.options.scales.y.max=a,l.options.scales.y.min=r,l.options.scales.y.beginAtZero=0===r}}catch(e){console.error("Error updating chart scales:",e)}}kintone.events.on(["app.record.detail.show","app.record.edit.show","app.record.create.show"],function(r){return setTimeout(()=>{const p=kintone.app.record.getSpaceElement(o.spaceId);p?async function(r,p){var y,w,M,R,S;try{!function(e){e.innerHTML='\n      <div class="loading-container" style="\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 40px;\n        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n      ">\n        <div class="loading-spinner" style="\n          width: 40px;\n          height: 40px;\n          border: 4px solid #f3f3f3;\n          border-top: 4px solid #3498db;\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n          margin-bottom: 16px;\n        "></div>\n        <div class="loading-text" style="\n          color: #666;\n          font-size: 14px;\n          text-align: center;\n        ">データを読み込み中...</div>\n        <style>\n          @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n        </style>\n      </div>\n    '}(r),u();const k=o.propertyAppId,L=o.ownerAppId,N=p&&o.currentAppOwnerId&&(null==(y=p[o.currentAppOwnerId])?void 0:y.value)||"",A={};async function D(e,t,n){if(!e)return{records:[]};const a=/^-?\d+(?:\.\d+)?$/.test(String(n||"").trim());if(t&&""!==n&&null!=n){try{const a=await kintone.api("/k/v1/records.json","GET",{app:e,query:`${t} = "${n}"`});if(Array.isArray(a.records)&&a.records.length>0)return a}catch(r){}if(a)try{const a=await kintone.api("/k/v1/records.json","GET",{app:e,query:`${t} = ${n}`});if(Array.isArray(a.records)&&a.records.length>0)return a}catch(r){}}try{return await x(e)}catch(r){return{records:[]}}}async function O(){var e,t;try{const n=await async function(e,t={},n=500,a="offset",r=5){const o="offset"===String(a||"offset").toLowerCase(),i=e.map(e=>{const a=t[e]||"";return o?async function(e,t="",n=500,a=5){function r(e,t,n){const a=[],r=String(e||"").trim();return r&&a.push(`(${r})`),a.push(`order by $id asc limit ${t} offset ${n}`),a.join(" ")}let o=0;try{const n={app:e,query:r(t,1,0),totalCount:!0,fields:[]},a=await kintone.api("/k/v1/records.json","GET",n);o=Number(a.totalCount||0)}catch(B){}if(!o||!isFinite(o)||o<0)return x(e,t,n);const i=[];for(let c=0;c<o;c+=n)i.push(c);const l=[];for(let c=0;c<i.length;c+=a){const o=i.slice(c,c+a).map(a=>{const o={app:e,query:r(t,n,a),totalCount:!1,fields:[]};return kintone.api("/k/v1/records.json","GET",o).then(e=>e.records||[])});(await Promise.all(o)).forEach(e=>{l.push(...e)}),await new Promise(e=>setTimeout(e,100))}return{records:l}}(e,a,n,r):x(e,a,n)}),l=await Promise.all(i),c={};return e.forEach((e,t)=>{c[e]=l[t]}),c}([L,k],{},500,"offset",5);return{owners:(null==(e=n[L])?void 0:e.records)||[],properties:(null==(t=n[k])?void 0:t.records)||[]}}catch(n){return console.error("全オーナーデータの取得に失敗:",n),{owners:[],properties:[]}}}N&&o.propertyOwnerId&&(A[k]=`${o.propertyOwnerId} = "${N}"`),N&&o.ownerId&&(A[L]=`${o.ownerId} = "${N}"`);const q="savedField"===String((null==o?void 0:o.averageMode)||"compute");s=!q;const[U,j]=await Promise.all([D(k,o.propertyOwnerId,N),D(L,o.ownerId,N)]);try{o.ownerId,o.propertyOwnerId,null==(w=U.records)||w.length,null==(M=j.records)||M.length,null==(R=allOwnersData.owners)||R.length,null==(S=allOwnersData.properties)||S.length}catch(B){}const H=b(U.records,j.records,{owners:[],properties:[]},p);f=H,function(r,u){!function(n,a){n.innerHTML="",n.classList.add("bi-dashboard-plugin");const r=document.createElement("div");r.className="container";const o=document.createElement("div");o.className="top-section",o.appendChild(function(e){const t=document.createElement("div");t.className="table-section";const n=g.map((t,n)=>{const a=m[n],r=e[a],o=s?"集計中":String(Math.round(r.average));return`<tr>\n            <td>${t}</td>\n            <td>${String(Math.round(r.current))}</td>\n            <td>${o}</td>\n            <td>${String(Math.round(r.forecast))}</td>\n        </tr>`}).join("");return t.innerHTML=`\n        <div class="table-container">\n            <table id="dataTable">\n                <thead>\n                    <tr>\n                        <th>項目名</th>\n                        <th>現状</th>\n                        <th>平均</th>\n                        <th>試算</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${n}\n                </tbody>\n            </table>\n        </div>\n    `,t}(a)),o.appendChild(function(){const e=document.createElement("div");return e.className="chart-section",e.innerHTML='\n        <div class="chart-container">\n            <div class="chart-controls">\n                <button class="chart-toggle-button active" data-chart="radar">レーダーチャート</button>\n                <button class="chart-toggle-button" data-chart="bar">棒グラフ</button>\n                <div class="compression-control">\n                    <input type="checkbox" id="compressionCheckbox" class="compression-checkbox">\n                    <label for="compressionCheckbox">平均を1として比較する</label>\n                </div>\n                <div class="grade-control">\n                    <input type="checkbox" id="gradeCheckbox" class="grade-checkbox" checked>\n                    <label for="gradeCheckbox">成績で表示する</label>\n                </div>\n                <button class="grade-info-button" title="成績基準を表示">ℹ</button>\n            </div>\n            <div class="chart-item">\n                <div id="radarChartContainer">\n                    <h3>財務指標レーダーチャート</h3>\n                    <div class="chart-canvas-wrap"><canvas id="radarChart"></canvas></div>\n                </div>\n                <div id="barChartContainer" style="display: none;">\n                    <h3>財務指標棒グラフ</h3>\n                    <div class="chart-canvas-wrap"><canvas id="barChart"></canvas></div>\n                </div>\n            </div>\n        </div>\n    ',e}());const i=document.createElement("div");i.className="bottom-section";const l=function(){const e=document.createElement("div");e.className="tabs";const t=[{key:"roa",label:"資産効率・ROA",active:!0},{key:"operatingCost",label:"運営コスト率・NOI"},{key:"incomeTax",label:"所得税率"}];return e.innerHTML=t.map(e=>`\n        <button class="tab-button${e.active?" active":""}" data-tab="${e.key}">${e.label}</button>\n    `).join(""),e}();i.appendChild(l);const c=e(a);c.id="roaTab";const d=t(a);d.id="operatingCostTab";const u=function(e){var t,n,a,r,o,i,l,c,d;const{incomeTax:s,ownerDetails:u,calculatedIncomeTaxable:p,calculatedIncomeTaxRate:m}=e,v=document.createElement("div");function g(e){const t=null==e?"":String(e);if(""===t)return"";const[n,a]=t.split(".");return(n.startsWith("-")?"-":"")+n.replace("-","").replace(/\B(?=(\d{3})+(?!\d))/g,",")+(void 0!==a?"."+a:"")}function y(e){return parseFloat(e.replace(/,/g,""))||0}function h(e){const t=e.value.replace(/,/g,"");if(t&&!isNaN(t)){const n=e.selectionStart,a=e.value,r=g(t);if(a!==r){e.value=r;const t=(a.match(/,/g)||[]).length,o=n+((r.match(/,/g)||[]).length-t);e.setSelectionRange(Math.max(0,Math.min(o,r.length)),Math.max(0,Math.min(o,r.length)))}}}function f(e,t){const n=[{rate:5,min:0,max:195e4},{rate:10,min:1950001,max:33e5},{rate:20,min:3300001,max:695e4},{rate:23,min:6950001,max:9e6},{rate:33,min:9000001,max:18e6},{rate:40,min:18000001,max:4e7},{rate:45,min:40000001,max:1/0}];let a=n.findIndex(t=>e>=t.min&&e<=t.max);if(-1===a&&(a=n.findIndex(e=>e.rate===t)),-1===a)return{lowerDiff:"0円",upperDiff:"0円"};const r=a>0?n[a-1]:null,o=a<n.length-1?n[a+1]:null,i=r?Math.max(0,e-r.max):0,l=o?Math.max(0,o.min-e):0;return{lowerDiff:g(i)+"円",upperDiff:g(l)+"円"}}function x(){const e=y(document.getElementById("incomeTaxCurrentIncome").value),t=parseInt(document.getElementById("incomeTaxCurrentTaxRate").value)||0,n=y(document.getElementById("incomeTaxForecastIncome").value),a=parseInt(document.getElementById("incomeTaxForecastTaxRate").value)||0;document.getElementById("currentIncomeDisplay").textContent=g(e)+"円",document.getElementById("currentRateDisplay").textContent=String(Math.round(t))+"%";const r=f(e,t);document.getElementById("currentLowerAmount").textContent=r.lowerDiff,document.getElementById("currentUpperAmount").textContent=r.upperDiff,document.getElementById("forecastIncomeDisplay").textContent=g(n)+"円",document.getElementById("forecastRateDisplay").textContent=String(Math.round(a))+"%";const o=f(n,a);document.getElementById("forecastLowerAmount").textContent=o.lowerDiff,document.getElementById("forecastUpperAmount").textContent=o.upperDiff}function b(){document.querySelectorAll(".tax-rate-table tbody tr").forEach(e=>{e.classList.remove("highlighted-current","highlighted-forecast")});const e=parseInt(document.getElementById("incomeTaxCurrentTaxRate").value)||0,t=parseInt(document.getElementById("incomeTaxForecastTaxRate").value)||0;if(e>0){const t=document.querySelector(`.tax-rate-table tbody tr[data-rate="${e}"]`);t&&t.classList.add("highlighted-current")}if(t>0){const e=document.querySelector(`.tax-rate-table tbody tr[data-rate="${t}"]`);e&&e.classList.add("highlighted-forecast")}}function _(e){const t=y(document.getElementById(`incomeTax${e}Rent`).value)-(y(document.getElementById(`incomeTax${e}Management`).value)+y(document.getElementById(`incomeTax${e}LandTax`).value)+y(document.getElementById(`incomeTax${e}BuildingTax`).value)+y(document.getElementById(`incomeTax${e}Repair`).value)+y(document.getElementById(`incomeTax${e}Maintenance`).value)+y(document.getElementById(`incomeTax${e}Interest`).value)+y(document.getElementById(`incomeTax${e}Depreciation`).value)+y(document.getElementById(`incomeTax${e}Insurance`).value)),n=function(e){return e<=0?0:e<=195e4?5:e<=33e5?10:e<=695e4?20:e<=9e6?23:e<=18e6?33:e<=4e7?40:45}(t);document.getElementById(`incomeTax${e}Income`).value=g(t),document.getElementById(`incomeTax${e}TaxRate`).value=n;const a={rowType:e,taxRate:n};if(document.dispatchEvent(new CustomEvent("incomeTax:taxRateUpdated",{detail:a})),window&&"function"==typeof window.setIncomeTaxRate)try{window.setIncomeTaxRate(e.toLowerCase(),n)}catch(B){}b(),x()}return v.className="tab-content",v.dataset.tab="incomeTax",v.innerHTML=`\n        <div class="form-container">\n            <table class="roa-table">\n                <thead>\n                    <tr>\n                        <th></th>\n                        <th>年賃料</th>\n                        <th>年管理費</th>\n                        <th>土地固都税</th>\n                        <th>建物固都税</th>\n                        <th>長期修繕計画経費</th>\n                        <th>メンテナンス経費</th>\n                        <th>借入金利息</th>\n                        <th>減価償却費</th>\n                        <th>保険料年額</th>\n                        <th>所得税課税所得</th>\n                        <th>所得税率</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">現状値</td>\n                        <td><input type="text" id="incomeTaxCurrentRent" value="${(null==(t=null==u?void 0:u.annual_rent)?void 0:t.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentManagement" value="${(null==(n=null==u?void 0:u.annual_management_fee)?void 0:n.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentLandTax" value="${(null==(a=null==u?void 0:u.land_property_tax)?void 0:a.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentBuildingTax" value="${(null==(r=null==u?void 0:u.building_property_tax)?void 0:r.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentRepair" value="${(null==(o=null==u?void 0:u.long_term_repair_cost)?void 0:o.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentMaintenance" value="${(null==(i=null==u?void 0:u.maintenance_cost)?void 0:i.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentInterest" value="${(null==(l=null==u?void 0:u.loan_interest)?void 0:l.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentDepreciation" value="${(null==(c=null==u?void 0:u.depreciation)?void 0:c.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentInsurance" value="${(null==(d=null==u?void 0:u.annual_insurance_premium)?void 0:d.value)??0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentIncome" value="${p||0}" readonly></td>\n                        <td><input type="text" id="incomeTaxCurrentTaxRate" value="${m||0}" readonly></td>\n                    </tr>\n                    <tr>\n                        <td class="row-label">試算値</td>\n                        <td><input type="text" id="incomeTaxForecastRent" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastManagement" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastLandTax" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastBuildingTax" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastRepair" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastMaintenance" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastInterest" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastDepreciation" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastInsurance" value="0"></td>\n                        <td><input type="text" id="incomeTaxForecastIncome" value="0" readonly></td>\n                        <td><input type="text" id="incomeTaxForecastTaxRate" value="0" readonly></td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n        \n        <div class="calculation-formula-container">\n            <div class="formula-content">\n                <p>課税所得 = 年賃料 - (年管理費 + 土地固都税 + 建物固都税 + 長期修繕計画経費 + メンテナンス経費 + 借入金利息 + 減価償却費 + 保険料年額)</p>\n            </div>\n        </div>\n        \n        <div class="tax-info-container">\n            <div class="tax-rate-table-container">\n                <table class="tax-rate-table">\n                    <thead>\n                        <tr>\n                            <th>課税所得</th>\n                            <th>税率</th>\n                            <th>控除額</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <tr data-rate="5">\n                            <td>0円から1,950,000円まで</td>\n                            <td>5%</td>\n                            <td>0円</td>\n                        </tr>\n                        <tr data-rate="10">\n                            <td>1,950,001円から3,300,000円まで</td>\n                            <td>10%</td>\n                            <td>97,500円</td>\n                        </tr>\n                        <tr data-rate="20">\n                            <td>3,300,001円から6,950,000円まで</td>\n                            <td>20%</td>\n                            <td>427,500円</td>\n                        </tr>\n                        <tr data-rate="23">\n                            <td>6,950,001円から9,000,000円まで</td>\n                            <td>23%</td>\n                            <td>636,000円</td>\n                        </tr>\n                        <tr data-rate="33">\n                            <td>9,000,001円から18,000,000円まで</td>\n                            <td>33%</td>\n                            <td>1,536,000円</td>\n                        </tr>\n                        <tr data-rate="40">\n                            <td>18,000,001円から40,000,000円まで</td>\n                            <td>40%</td>\n                            <td>2,796,000円</td>\n                        </tr>\n                        <tr data-rate="45">\n                            <td>40,000,001円から</td>\n                            <td>45%</td>\n                            <td>4,796,000円</td>\n                        </tr>\n                    </tbody>\n                </table>\n            </div>\n            \n            <div class="tax-difference-container">\n                <div class="difference-info">\n                    <div class="current-info">\n                        <h5>現状値</h5>\n                        <div id="currentDifferenceInfo">\n                            <p>課税所得: <span id="currentIncomeDisplay">0円</span></p>\n                            <p>適用税率: <span id="currentRateDisplay">0%</span></p>\n                            <p id="currentLowerDiff">一つ下の税率まで: <span id="currentLowerAmount">-</span></p>\n                            <p id="currentUpperDiff">一つ上の税率まで: <span id="currentUpperAmount">-</span></p>\n                        </div>\n                    </div>\n                    <div class="forecast-info">\n                        <h5>試算値</h5>\n                        <div id="forecastDifferenceInfo">\n                            <p>課税所得: <span id="forecastIncomeDisplay">0円</span></p>\n                            <p>適用税率: <span id="forecastRateDisplay">0%</span></p>\n                            <p id="forecastLowerDiff">一つ下の税率まで: <span id="forecastLowerAmount">-</span></p>\n                            <p id="forecastUpperDiff">一つ上の税率まで: <span id="forecastUpperAmount">-</span></p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `,setTimeout(()=>{["incomeTaxCurrentRent","incomeTaxCurrentManagement","incomeTaxCurrentLandTax","incomeTaxCurrentBuildingTax","incomeTaxCurrentRepair","incomeTaxCurrentMaintenance","incomeTaxCurrentInterest","incomeTaxCurrentDepreciation","incomeTaxCurrentInsurance","incomeTaxCurrentIncome","incomeTaxCurrentTaxRate"].forEach(e=>{const t=document.getElementById(e);t&&h(t)});const e=document.getElementById("incomeTaxCurrentIncome").value,t=document.getElementById("incomeTaxCurrentTaxRate").value;"0"===e&&"0"===t?_("Current"):(b(),x()),["Rent","Management","LandTax","BuildingTax","Repair","Maintenance","Interest","Depreciation","Insurance"].forEach(e=>{const t=document.getElementById(`incomeTaxCurrent${e}`),n=document.getElementById(`incomeTaxForecast${e}`);t&&n&&(n.value=t.value)});const n=document.getElementById("incomeTaxCurrentIncome"),a=document.getElementById("incomeTaxCurrentTaxRate"),r=document.getElementById("incomeTaxForecastIncome"),o=document.getElementById("incomeTaxForecastTaxRate");n&&r&&(r.value=n.value),a&&o&&(o.value=a.value),["incomeTaxForecastRent","incomeTaxForecastManagement","incomeTaxForecastLandTax","incomeTaxForecastBuildingTax","incomeTaxForecastRepair","incomeTaxForecastMaintenance","incomeTaxForecastInterest","incomeTaxForecastDepreciation","incomeTaxForecastInsurance","incomeTaxForecastIncome","incomeTaxForecastTaxRate"].forEach(e=>{const t=document.getElementById(e);t&&h(t)}),_("Forecast"),["incomeTaxForecastRent","incomeTaxForecastManagement","incomeTaxForecastLandTax","incomeTaxForecastBuildingTax","incomeTaxForecastRepair","incomeTaxForecastMaintenance","incomeTaxForecastInterest","incomeTaxForecastDepreciation","incomeTaxForecastInsurance"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",e=>{h(e.target),_("Forecast")}),t.addEventListener("blur",e=>{h(e.target)}))})},200),v}(a);u.id="incomeTaxTab";const p=function(){const e=document.createElement("div");return e.className="tab-content",e.dataset.tab="inheritanceTax",e.innerHTML='\n        <div class="form-container">\n            <div class="unimplemented-message">\n                <h3>未実装</h3>\n                <p>機能追加のご依頼をお待ちしております。<br>ほっとビジネスサポート(株)</p>\n            </div>\n        </div>\n    ',e}(a.inheritanceTax);p.id="inheritanceTaxTab";const v=function(){const e=document.createElement("div");return e.className="tab-content",e.dataset.tab="borrowing",e.innerHTML='\n        <div class="form-container">\n            <div class="unimplemented-message">\n                <h3>未実装</h3>\n                <p>機能追加のご依頼をお待ちしております。<br>ほっとビジネスサポート(株)</p>\n            </div>\n        </div>\n    ',e}(a.borrowing);v.id="borrowingTab",i.appendChild(c),i.appendChild(d),i.appendChild(u),i.appendChild(p),i.appendChild(v),r.appendChild(o),r.appendChild(i),n.appendChild(r)}(r,u);const p=r.querySelector(".container");(function(e){if(!e)return;requestAnimationFrame(()=>{e.style.width="1400px",e.style.minWidth="1400px",e.style.maxWidth="1400px",e.style.boxSizing="border-box"})})(p),function(e){try{const t=document.getElementById("radarChart"),n=document.getElementById("barChart");if(!t||!n)return void console.error("Chart canvas elements not found");const a=t.getContext("2d"),r=n.getContext("2d"),o=v.map((t,n)=>{const a=C(t,e);return{label:String(h[n].label),data:a.map(e=>Number(e)||0),borderColor:String(h[n].border),backgroundColor:String(h[n].bgRadar),borderWidth:Number(h[n].bwRadar),hidden:!("average"!==t||!s)}}),c=v.map((t,n)=>{const a=C(t,e);return{label:String(h[n].label),data:a.map(e=>Number(e)||0),backgroundColor:String(h[n].bgBar),borderColor:String(h[n].border),borderWidth:Number(h[n].bwBar),hidden:!("average"!==t||!s)}});i=new Chart(a,{type:"radar",data:{labels:g.map(e=>String(e)),datasets:o},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{r:{beginAtZero:!0,max:100,min:0,type:"radialLinear"}},plugins:{legend:{position:"bottom"}}}}),l=new Chart(r,{type:"bar",data:{labels:g.map(e=>String(e)),datasets:c},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,resizeDelay:100,scales:{y:{beginAtZero:!0,max:100,min:0,type:"linear"}},plugins:{legend:{position:"bottom"}}}}),F()}catch(t){console.error("Error initializing charts:",t),console.error("Error stack:",t.stack)}}(u),document.querySelectorAll('input[type="number"]').forEach(e=>{e.addEventListener("input",function(){const e=function(e){for(const t of v){const n=_(t);if(e.endsWith(n)){const a=e.slice(0,-n.length);if(m.includes(a))return{metric:a,field:t}}}return null}(this.id);if(!e)return;const{metric:t,field:n}=e;f[t][n]=parseFloat(this.value)||0,T(),I()})}),function(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{!function(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`.tab-content[data-tab="${e}"]`)||document.getElementById(`${e}Tab`),n=document.querySelector(`.tab-button[data-tab="${e}"]`);t&&t.classList.add("active");n&&n.classList.add("active")}(e.dataset.tab)})}),document.querySelectorAll(".chart-toggle-button").forEach(e=>{e.addEventListener("click",()=>{!function(e){document.querySelectorAll(".chart-toggle-button").forEach(e=>e.classList.remove("active"));const t=document.getElementById("radarChartContainer"),n=document.getElementById("barChartContainer");if(!t||!n)return;if(t.style.display="none",n.style.display="none","radar"===e){t.style.display="block";const e=document.querySelector('.chart-toggle-button[data-chart="radar"]');e&&e.classList.add("active"),requestAnimationFrame(()=>{i&&i.resize()})}else{n.style.display="block";const e=document.querySelector('.chart-toggle-button[data-chart="bar"]');e&&e.classList.add("active"),requestAnimationFrame(()=>{l&&l.resize()})}}(e.dataset.chart)})}),document.querySelectorAll(".compression-checkbox").forEach(e=>{e.addEventListener("change",()=>{!function(){const e=document.querySelector(".compression-checkbox");e&&(c=e.checked);if(c){const e=document.querySelector(".grade-checkbox");e&&(e.checked=!1),d=!1}F(),I()}()})}),document.querySelectorAll(".grade-checkbox").forEach(e=>{e.addEventListener("change",()=>{!function(){const e=document.querySelector(".grade-checkbox");e&&(d=e.checked);if(d){const e=document.querySelector(".compression-checkbox");e&&(e.checked=!1),c=!1}F(),I()}()})});const e=document.querySelector(".grade-info-button");e&&e.addEventListener("click",()=>{!function(){var e;try{const t=function(){const e={},t=function(){try{return a(n)}catch(B){try{return function(e){const t={};return["assetEfficiency","roa","incomeTax","operatingCost","noi"].forEach(n=>{const a=null==e?void 0:e[n];if(!a||!Array.isArray(a.levels))return;const r="boolean"!=typeof a.includeLower||a.includeLower,o="boolean"==typeof a.includeUpper&&a.includeUpper;t[n]=a.levels.map(e=>({score:parseInt(e.grade,10)||"",min:E(e.min,!0),max:E(e.max,!1),includeLower:"gte"===e.minType||"gt"!==e.minType&&r,includeUpper:"lte"===e.maxType||"lt"!==e.maxType&&o}))}),t}("string"==typeof(null==o?void 0:o.gradeSettings)?JSON.parse(o.gradeSettings):(null==o?void 0:o.gradeSettings)||{})}catch(e){return{}}}}();return Object.keys(t).forEach(n=>{const a=Array.isArray(t[n])?t[n]:[];e[n]=a.map(e=>({gradeLabel:String(e.score??""),min:e.min,max:e.max,includeLower:Boolean(e.includeLower),includeUpper:Boolean(e.includeUpper)}))}),e}(),r=document.createElement("div");r.className="grade-info-overlay",r.innerHTML=`\n        <div class="grade-info-modal">\n          <div class="grade-info-header">\n            <h3>成績基準一覧</h3>\n            <button class="grade-info-close" aria-label="閉じる">×</button>\n          </div>\n          <div class="grade-info-body">\n            ${function(e){const t={assetEfficiency:"資産効率(%)",roa:"ROA(%)",incomeTax:"所得税率(%)",operatingCost:"運営コスト率(%)",noi:"NOI率(%)"},n='<div class="grade-info-legend">\n      <p>上から順に適用されます。区間表記は [ を「含む」、( を「含まない」、] を「含む」、) を「含まない」と表します。</p>\n      <p>例: [10, 20) は「10以上 20未満」を意味します。</p>\n    </div>',a=Object.keys(e).map(n=>{const a=e[n].map(e=>{const t=function(e,t,n,a){const r=a?"]":")";return`${n?"[":"("}${$(e)}, ${$(t)}${r}`}(e.min,e.max,e.includeLower,e.includeUpper),n=function(e,t,n,a){const r=t?"以上":"超過",o=a?"以下":"未満",i=e===-1/0,l=n===1/0;return i&&l?"制限なし":i?`${$(n)}${o}`:l?`${$(e)}${r}`:`${$(e)}${r} かつ ${$(n)}${o}`}(e.min,e.includeLower,e.max,e.includeUpper);return`<tr>\n          <td><span class="grade-badge">${a=e.gradeLabel,String(a??"").replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}</span></td>\n          <td>${t}</td>\n          <td>${n}</td>\n        </tr>`;var a}).join("");return`<div class="grade-info-section">\n        <h4>${t[n]||n}</h4>\n        <table class="grade-info-table">\n          <thead><tr><th>成績</th><th>区間</th><th>条件</th></tr></thead>\n          <tbody>${a}</tbody>\n        </table>\n      </div>`}).join("");return n+a}(t)}\n          </div>\n        </div>`,document.body.appendChild(r),null==(e=r.querySelector(".grade-info-close"))||e.addEventListener("click",()=>r.remove()),r.addEventListener("click",e=>{e.target===r&&r.remove()})}catch(t){console.error("Failed to open grade info modal:",t)}}()})}(),document.addEventListener("incomeTax:taxRateUpdated",e=>{const t=e&&e.detail?e.detail:{},n=t.rowType,a=Number(t.taxRate)||0;"Current"===n?f.incomeTax.current=a:"Forecast"===n?f.incomeTax.forecast=a:"Average"===n&&(f.incomeTax.average=a),T(),I()}),window.setIncomeTaxRate=function(e,t){const n=(e||"").toLowerCase(),a=Number(t)||0;"current"===n&&(f.incomeTax.current=a),"forecast"===n&&(f.incomeTax.forecast=a),"average"===n&&(f.incomeTax.average=a),T(),I()},document.addEventListener("operatingCost:rateUpdated",e=>{const t=e&&e.detail?e.detail:{},n=t.rowType,a=Number(t.rate)||0;"Current"===n?f.operatingCost.current=a:"Forecast"===n&&(f.operatingCost.forecast=a),T(),I()}),T(),setTimeout(()=>{i&&i.resize(),l&&l.resize()},0)}(r,H),q?(s=!1,T(),I()):O().then(e=>{try{const t=b(U.records,j.records,e,p);f=t,s=!1,T(),I()}catch(t){console.error("平均再計算に失敗:",t),s=!1}}).catch(e=>{console.error("全オーナー平均の取得に失敗:",e),s=!1})}catch(P){console.error("Failed to fetch or process kintone data:",P),r.innerHTML="<p>データの取得に失敗しました。</p>"}}(p,r&&r.record):o.spaceId},0),r})}()}();
